---
title: "EBA manuscript figures"
subtitle: "Proposed figures for publication" 
author: "Natasha Strydom"
date: "`r Sys.Date()`"
output:
  html_notebook:
    code_folding: hide
    fig_caption: yes
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes
---


This document details is a template for all the EBA proposed figures
It is still a work in progress

##Libraries and Session info

```{r eval=FALSE, include=TRUE}
library(readr) # read csv files with option to skip rows
library(dplyr) # data wrangling
library(ggplot2) # data plotting
library(xpose) # model diagnostics in base R
library(xpose4) # model diagnostics in ggplot
library(gridExtra) # paste multiple plots together
library(grid) #add text & spacers to plots more easily
```

*    
Links to package documents:  
  
[```readr```](https://readr.tidyverse.org/)     
[```dplyr```](http://dplyr.tidyverse.org/)   
[```ggplot2```](http://ggplot2.org/)  
[```xpose```](https://uupharmacometrics.github.io/xpose/)  
[```xpose4```](http://xpose.sourceforge.net/)  
[```gridExtra```](https://cran.r-project.org/web/packages/gridExtra/gridExtra.pdf) 

```{r}
EBA_team <- c(
  "#42B1AF",
  "#D12831",
  "#737478",
  "#FCC522",
  "#A6CEE3", "#B2DF8A","#FB9A99","#FDBF6F", "#CAB2D6", "#FFFF99",
   "#1F78B4", "#33A02C",
    "#FF7F00", "#6A3D9A", "#B15928"
)
```

#Drug colors
```{r}
drug_colors <- c(
  "BDQ" = "#42B1AF",  #teal
  "DLM" =  "#F57F20", #orange
  "INH" = "#2078B4", #blue
  "LZD" = "#FCC522",#yellow
  "MXF" = "#737478",#grey
  "PA-824" = "#34A048", #green
  "PZA" = "#FB9A99", #pink
  "RIF" = "#D12831",#red
  "RPT" =  "#6B3E98" # purple
  )

```

#Functions

```{r}
plotPK <- function(drug_dataset, drug_sum_PK, breakII) {
  ggplot(drug_dataset, aes(TIME, DV, color = factor(DOSE))) +
    geom_point(shape = 1) +
    geom_line(data = drug_sum_PK, aes(TIME, medianCc)) +
    scale_color_manual(values = EBA_team) +
    scale_x_continuous(limits = c(0, NA), breaks = seq(0, 264, breakII)) +
    facet_wrap(~DRUG, nrow = 1, scales = "free") +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
}
# need better solve for multidosing...
plotMultiPK <- function(drug_dataset, drug_sum_PK, breakII) {
  ggplot(DLM_PK_nm, aes(TIME, DV, color = factor(DOSE), group = GROUP)) +
    geom_point(shape = 1) +
    geom_line(data = drug_sum_PK, aes(TIME, medianCc)) +
    scale_color_manual(values = EBA_team) +
    scale_x_continuous(limits = c(0, NA), breaks = seq(0, 264, 48)) +
    facet_wrap(~DRUG, nrow = 1, scales = "free") +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
}

plotPD <- function(drug_dataset, drug_sum_PD, breakII, start_treatment) {
  ggplot(drug_dataset, aes(TIME, DV, color = factor(DOSE), group = GROUP)) +
    geom_point(shape = 1) +
    geom_line(data = drug_sum_PD, aes(TIME, medianCc)) +
    scale_color_manual(values = EBA_team) +
    scale_y_continuous(limits = c(0, 10)) +
    scale_x_continuous(limits = c(0, NA), breaks = seq(0, 264, breakII)) +
    facet_wrap(~DRUG, nrow = 1, scales = "free") +
    geom_vline(linetype = 2, xintercept = start_treatment) +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
}

sumPK_median <- function(drug_PK_dataset) {
  summaryPK <- drug_PK_dataset %>%
    group_by(TIME, DOSE, DRUG, GROUP) %>%
    summarise(medianCc = median(DV))
}

sumPD_median <- function(drug_PK_dataset) {
  summaryPK <- drug_PK_dataset %>%
    group_by(TIME, DOSE, DRUG, GROUP) %>%
    summarise(medianCc = median(DV))
}
```


Session Info
```{r}
sessionInfo()
```

#Table 1: DATABASE

#Figure 2: PKPD, human+mouse
## Raw PK
###PZA
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PK/PZA/")
#setwd("~/Dropbox (Savic_Lab)/Nan/drug_combination/data/parsed")
# change nm dataset csv file to drug_PK_nm.csv if possible
#PZA_PK_nm <- read.csv(file="../data/raw_data/PK/PZA/PZA.PK5.csv", sep = ",", 
   PZA_PK_nm <- read.csv(file="PZA.PK5.csv", sep = ",",
                         na.strings=".", as.is=TRUE,header=TRUE)%>%
  mutate(
    DRUG = "PZA",
    ID = ID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIME,
    DV = DV,
    DOSE = DRUGDOSE,
    GROUP = 1 # if multiple dosing use group, see DLM
  ) %>%
  filter(
    MDV == 0&TIME<25 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

PZA_PK_nm$DV <- as.numeric(as.character(PZA_PK_nm$DV))
PZA_sum_PK <- sumPK_median(PZA_PK_nm)

# use plotMultiPK if multiple dosing
# adjust breakII to 2, 4, 6, 12 or 24 for best x-axis breaks
PZAplotPK <- plotPK(PZA_PK_nm, PZA_sum_PK, 2)
logPZAplotPK <- PZAplotPK + scale_y_log10() #+ theme(legend.position = "none")

PZAplotPK # Check plots and make appropriate adjustments
logPZAplotPK # Don't worry about plot size yet
```
###BDQ
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PK/BDQ/")

# change nm dataset csv file to drug_PK_nm.csv if possible
BDQ_PK_nm <- read_csv("BDQ_PK_nm.csv", skip = 3) %>%
  mutate(
    DRUG = "BDQ",
    ID = CID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIMEH,
    DV = DV,
    DOSE = DOSE,
    GROUP = 1 # if multiple dosing use group, see DLM
  ) %>%
  filter(
    MDV == 0,
    CMT == 2 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

BDQ_PK_nm$DV <- as.numeric(as.character(BDQ_PK_nm$DV))
BDQ_sum_PK <- sumPK_median(BDQ_PK_nm)

# use plotMultiPK if multiple dosing
# adjust breakII to 2, 4, 6, 12 or 24 for best x-axis breaks
BDQplotPK <- plotPK(BDQ_PK_nm, BDQ_sum_PK, 24)
logBDQplotPK <- BDQplotPK + scale_y_log10()

BDQplotPK # Check plots and make appropriate adjustments
logBDQplotPK # Don't worry about plot size yet
```

###DLM
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PK/DLM/")

DLM_PK_nm <- read_csv("Delam-PK-nm-v5.csv", skip = 3) %>%
  mutate(
    DRUG = "DLM",
    ID = CID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIMEH,
    DV = DV,
    DOSE = DOSE,
    GROUP = ifelse(TIMEH > 100, CID + 1000, CID + 2000) # use for multiple dosing
  ) %>%
  filter(
    MDV == 0 & CID <=3 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

DLM_PK_nm$DV <- as.numeric(as.character(DLM_PK_nm$DV))
DLM_sum_PK <- sumPK_median(DLM_PK_nm)

# use plotMultiPK if multiple dosing
# adjust breakII to 2, 4, 6, 12 or 24 for best x-axis breaks
DLMplotPK <- plotPK(DLM_PK_nm, DLM_sum_PK, 6)

logDLMplotPK <- DLMplotPK +
  scale_y_log10()

DLMplotPK # Check plots and make appropriate adjustments
logDLMplotPK # Don't worry about size
```
###INH
```{r}
# #select all, CMD+SHIFT+C to uncomment
# #copy dataset into following directory
#setwd("../data/raw_data/PK/PZA/")
#
# #change nm dataset csv file to drug_PK_nm.csv if possible
INH_PK_nm <- read.csv("../data/raw_data/PK/INH/INH.PK_01172018.csv", sep = ",", na.strings=".", as.is=TRUE,header=TRUE) %>%
   mutate(
     DRUG = "INH",
     ID = ID,      #assign ID, TIME, DV, DOSE & GROUP
     TIME = TIME,
     DV = DV,
     DOSE = DOSE,
     GROUP = 1      #if multiple dosing use group, see DLM
   ) %>%
   filter(
     MDV==0         #filter to observations used in final model
   ) %>%
   select(ID, TIME, DV, DOSE, DRUG, GROUP)
#
 INH_PK_nm$DV <- as.numeric(as.character(INH_PK_nm$DV))
 INH_sum_PK <- sumPK_median(INH_PK_nm)
#
# #use plotMultiPK if multiple dosing
# #adjust breakII to 2, 4, 6, 12 or 24 for best x-axis breaks
 INHplotPK <- plotPK(INH_PK_nm, INH_sum_PK, 2)
 logINHplotPK <- INHplotPK+scale_y_log10()
#
 INHplotPK    #Check plots and make appropriate adjustments
 logINHplotPK #Don't worry about plot size yet
```
###LZD
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PK/LZD/")

# change nm dataset csv file to drug_PK_nm.csv if possible
LZD_PK_nm <- read_csv("LZD_PK_nm.csv", skip = 3) %>%
  mutate(
    DRUG = "LZD",
    ID = CID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIME,
    DV = DV,
    DOSE = DOSE,
    GROUP = 1 # if multiple dosing use group, see DLM
  ) %>%
  filter(
    MDV == 0, # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

LZD_PK_nm$DV <- as.numeric(as.character(LZD_PK_nm$DV))
LZD_sum_PK <- sumPK_median(LZD_PK_nm)

# use plotMultiPK if multiple dosing
# adjust breakII to 2, 4, 6, 12 or 24 for best x-axis breaks
LZDplotPK <- plotPK(LZD_PK_nm, LZD_sum_PK, 6)
logLZDplotPK <- LZDplotPK + scale_y_log10()

LZDplotPK # Check plots and make appropriate adjustments
logLZDplotPK # Don't worry about plot size yet
```

###MFX
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PK/MFX/")

# change nm dataset csv file to drug_PK_nm.csv if possible
MFX_PK_nm <- read_csv("MOX.PK.NM.csv", skip = 0) %>%
  mutate(
    DRUG = "MFX",
    ID = IDDOSEL, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIME,
    DV = DV,
    DOSE = DOSEL,
    GROUP = 1 # if multiple dosing use group, see DLM
  ) %>%
  filter(
    MDV == 0 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

MFX_PK_nm$DV <- as.numeric(as.character(MFX_PK_nm$DV))
MFX_sum_PK <- sumPK_median(MFX_PK_nm)

# use plotMultiPK if multiple dosing
# adjust breakII to 2, 4, 6, 12 or 24 for best x-axis breaks
MFXplotPK <- plotPK(MFX_PK_nm, MFX_sum_PK,4)
logMFXplotPK <- MFXplotPK + scale_y_log10() 

MFXplotPK # Check plots and make appropriate adjustments
logMFXplotPK # Don't worry about plot size yet
```
###PA824
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PK/PA824/")

# change nm dataset csv file to drug_PK_nm.csv if possible
PA824_PK_nm <- read_csv("PA.PK.NM.csv", skip = 3) %>%
  mutate(
    DRUG = "PA824",
    ID = ID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TAD,
    DV = DV,
    DOSE = DOSE,
    GROUP = 1 # if multiple dosing use group, see DLM
  ) %>%
  filter(
    MDV == 0 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

PA824_PK_nm$DV <- as.numeric(as.character(PA824_PK_nm$DV))
PA824_sum_PK <- sumPK_median(PA824_PK_nm)

# use plotMultiPK if multiple dosing
# adjust breakII to 2, 4, 6, 12 or 24 for best x-axis breaks
PA824plotPK <- plotPK(PA824_PK_nm, PA824_sum_PK, 24)
logPA824plotPK <- PA824plotPK + scale_y_log10()

PA824plotPK # Check plots and make appropriate adjustments
logPA824plotPK # Don't worry about plot size yet
```
###RIF
```{r}
# #select all, CMD+SHIFT+C to uncomment
# #copy dataset into following directory
#
# #change nm dataset csv file to drug_PK_nm.csv if possible
RIF_PK_nm <- read.csv(file = "../data/raw_data/PK/RIF/R.PK_05162019.csv", header = TRUE, sep = ",", na.strings=".", as.is=TRUE) %>%
   mutate(
     DRUG = "RIF",
     ID = ID,      #assign ID, TIME, DV, DOSE & GROUP
     TIME = TAD,
     DV = DV,
     DOSE = DOSEL,
     GROUP = 1      #if multiple dosing use group, see DLM
   ) %>%
   filter(
     MDV==0        #filter to observations used in final model
   ) %>%
   select(ID, TIME, DV, DOSE, DRUG, GROUP)
#
 RIF_PK_nm$DV <- as.numeric(as.character(RIF_PK_nm$DV))
 RIF_sum_PK <- sumPK_median(RIF_PK_nm)

# #use plotMultiPK if multiple dosing
# #adjust breakII to 2, 4, 6, 12 or 24 for best x-axis breaks
 RIFplotPK <- plotPK(RIF_PK_nm, RIF_sum_PK, 12)
 logRIFplotPK <- RIFplotPK+scale_y_log10()
#
 RIFplotPK    #Check plots and make appropriate adjustments
 logRIFplotPK #Don't worry about plot size yet


```
###RPT
```{r}
#select all, CMD+SHIFT+C to uncomment
#copy dataset into following directory
setwd("../data/raw_data/PK/RPT/")

#change nm dataset csv file to drug_PK_nm.csv if possible
RPT_PK_nm <- read_csv("RPT_PK_nm.csv", skip = 3) %>%
  mutate(
    DRUG = "RPT",
    ID = CID,      #assign ID, TIME, DV, DOSE & GROUP
    TIME = TAD,
    DV = DV,
    DOSE = DOSEL,
    GROUP = 1      #if multiple dosing use group, see DLM
  ) %>%
  filter(
    MDV==0        #filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

RPT_PK_nm$DV <- as.numeric(as.character(RPT_PK_nm$DV))
RPT_sum_PK <- sumPK_median(RPT_PK_nm)

#use plotMultiPK if multiple dosing
#adjust breakII to 2, 4, 6, 12 or 24 for best x-axis breaks
RPTplotPK <- plotPK(RPT_PK_nm, RPT_sum_PK, 24)
logRPTplotPK <- RPTplotPK+scale_y_log10()

RPTplotPK    #Check plots and make appropriate adjustments
logRPTplotPK #Don't worry about plot size yet
```

##Plot final PK data
```{r fig.height=2.5, fig.width=7}
grid.arrange(
  BDQplotPK,
  DLMplotPK,
  INHplotPK,
  LZDplotPK,
  MFXplotPK,
  PA824plotPK,
   PZAplotPK,
  RIFplotPK,
  RPTplotPK,
  logBDQplotPK,
  logDLMplotPK,
  logINHplotPK,
  logLZDplotPK,
  logMFXplotPK,
  logPA824plotPK,
   logPZAplotPK,
  logRIFplotPK,
  logRPTplotPK,
  nrow = 2
)
```
Log plot (likely final)
```{r fig.height=8, fig.width=8}
linearPK <- grid.arrange(
  BDQplotPK,
  DLMplotPK,
  INHplotPK,
  LZDplotPK,
  MFXplotPK,
  PA824plotPK,
  PZAplotPK,
  RIFplotPK,
  RPTplotPK,
  nrow = 3,
  left="Concentration (mg/L)",
  bottom="Time (hrs)"
)

logPK <- grid.arrange(
  logBDQplotPK,
  logDLMplotPK,
  logINHplotPK,
  logLZDplotPK,
  logMFXplotPK,
  logPA824plotPK,
  logPZAplotPK,
  logRIFplotPK,
  logRPTplotPK,
  nrow = 3,
  left="Log-scaled concentration (mg/L)",
  bottom="Time (hrs)"
)

#linearPK
logPK

#ggsave(plot = logPK, "../Manuscript/eba_figures/figure1.pdf", width = 12, height = 12)
```

## Raw PD
###BDQ
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PD/BDQ/")

# change nm dataset csv file to drug_PD_nm.csv if possible
BDQ_PD_nm <- read_csv("BDQ_PD_nm.csv", skip = 2) %>%
  mutate(
    DRUG = "BDQ",
    ID = CID, # assign ID, TIME, DV & DOSE
    TIME = TAD,
    DV = LOG10CFU, # use log10 DV
    DOSE = DOSE,
    GROUP = DOSE # change if other grouping for median is needed
  ) %>%
  filter(
    MDV == 0 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

BDQ_PD_nm$DV <- as.numeric(as.character(BDQ_PD_nm$DV))
BDQ_sum_PD <- sumPD_median(BDQ_PD_nm)

inoculation_day = -14
start_treatment = 0

# adjust breakII to 1, 7 or 28 for best x-axis breaks
# adjust start_treatment to day of the start if treatment
# BDQplotPD <- plotPD(BDQ_PD_nm, BDQ_sum_PD, 24, 0)
# 
# BDQplotPD # Check plots and make appropriate adjustments

BDQplotPD<- ggplot(BDQ_PD_nm, aes(TIME, DV, color = factor(DOSE), group = GROUP)) +
    geom_point(shape = 1) +
    geom_line(data = BDQ_sum_PD, aes(TIME, medianCc)) +
    scale_color_manual(values = EBA_team) +
    scale_y_continuous(limits = c(0, 10)) +
    scale_x_continuous(limits = c(-14, NA), breaks = c(-14,0,28,56,84)) +
    facet_wrap(~DRUG, nrow = 1, scales = "free") +
    #geom_vline(linetype = 2, xintercept = inoculation_day) +
    geom_vline(linetype = 2, xintercept = start_treatment) +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
BDQplotPD
```

###DLM
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PD/DLM/")

DLM_PD_nm <- read_csv("DLM.PD.NM.csv") %>%
  mutate(
    DRUG = "DLM",
    ID = ID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIMAST,
    DV = LOGDV,
    DOSE = DOSED,
    GROUP = DOSED # change if other grouping for median is needed
  ) %>%
  filter(
    MDV == 0 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

DLM_PD_nm$DV <- as.numeric(as.character(DLM_PD_nm$DV))
DLM_sum_PD <- sumPD_median(DLM_PD_nm)
start_treatment = 0

# adjust breakII to 1, 7 or 28 for best x-axis breaks
# adjust start_treatment to day of the start if treatment
DLMplotPD<- ggplot(DLM_PD_nm, aes(TIME, DV, color = factor(DOSE), group = GROUP)) +
    geom_point(shape = 1) +
    geom_line(data = DLM_sum_PD, aes(TIME, medianCc)) +
    scale_color_manual(values = EBA_team) +
    scale_y_continuous(limits = c(0, 10)) +
    scale_x_continuous(limits = c(-14, NA), breaks = c(-14,0,14,28,56,84)) +
    facet_wrap(~DRUG, nrow = 1, scales = "free") +
    #geom_vline(linetype = 2, xintercept = inoculation_day) +
    geom_vline(linetype = 2, xintercept = start_treatment) +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
DLMplotPD
#DLMplotPD <- plotPD(DLM_PD_nm, DLM_sum_PD)

#DLMplotPD # Check plots and make appropriate adjustments
```

###RIF
```{r}
EBA_team <- c(
  "#42B1AF",
  "#D12831",
  "#A6CEE3",
  "#737478",
  "#FCC522",
  "#A6CEE3", "#B2DF8A","#FB9A99","#FDBF6F", "#CAB2D6", "#FFFF99",
   "#1F78B4", "#33A02C",
    "#FF7F00", "#6A3D9A", "#B15928"
)
# copy dataset into following directory


# change nm dataset csv file to drug_PD_nm.csv if possible
RIF_PD_nm <- read.csv("../data/raw_data/PD/RIF/BalbC_allbaseline_MONO_NONMEM_06122019_BASELINE.csv", header = TRUE, sep =",", as.is=TRUE, na.strings=".") %>%
  mutate(
    DRUG = "RIF",
    ID = ID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIMAST,
    DV = LOGDV,
    DOSE = DOSER,
    GROUP = ID # change if other grouping for median is needed
  ) %>%
  filter(
    MDV == 0, # filter to observations used in final model
    DOSE != 0
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

RIF_PD_nm$DV <- as.numeric(as.character(RIF_PD_nm$DV))
RIF_sum_PD <- sumPD_median(RIF_PD_nm)

# adjust breakII to 1, 7 or 28 for best x-axis breaks
# adjust start_treatment to day of the start if treatment
RIFplotPD <- plotPD(RIF_PD_nm, RIF_sum_PD, 4, 0)+geom_vline(xintercept = 0, linetype = 2)+scale_x_continuous(breaks = seq(-56, 64, 14))

RIFplotPD # Check plots and make appropriate adjustments

EBA_team <- c(
  "#42B1AF",
  "#D12831",
  "#737478",
  "#FCC522",
  "#A6CEE3", "#B2DF8A","#FB9A99","#FDBF6F", "#CAB2D6", "#FFFF99",
   "#1F78B4", "#33A02C", # "#E31A1C",
    "#FF7F00", "#6A3D9A", "#B15928"
)
```


###INH
Might need to consider dropping some studies to provide only overview plot
```{r}

EBA_team <- c(
  "#42B1AF",
  "#D12831",
  "#737478",
  "#FCC522",
  "#A6CEE3", "#B2DF8A","#FB9A99", "#CAB2D6",# "#FFFF99",
   "#1F78B4", "#33A02C", # "#E31A1C",
    "#FF7F00", "#6A3D9A", "#B15928"
)

plotPD2 <- function(drug_dataset, drug_sum_PD, breakII, start_treatment) {
  ggplot(drug_dataset, aes(TIME, DV, color = factor(DOSE), group = GROUP)) +
    geom_point(shape = 1) +
    geom_line(data = drug_sum_PD, aes(TIME, medianCc)) +
    scale_color_manual(values = EBA_team) +
    scale_y_continuous(limits = c(0, 12), breaks = c(0, 2.5, 5, 7.5, 10)) +
    #scale_x_continuous(limits = c(0, NA), breaks = seq(0, 264, breakII)) +
    facet_wrap(~DRUG, nrow = 1, scales = "free") +
    #geom_vline(linetype = 2, xintercept = start_treatment) +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
}
# copy dataset into following directory
# change nm dataset csv file to drug_PD_nm.csv if possible
INH_PD_nm <- read.csv("../data/raw_data/PD/INH/BalbC_allbaseline_MONO_NONMEM_06122019_BASELINE.csv", header = TRUE, sep =",", as.is=TRUE, na.strings=".") %>%
  mutate(
    DRUG = "INH",
    ID = ID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIMAST,
    DV = LOGDV,
    DOSE = DDOSEH,
    GROUP = STUDY # change if other grouping for median is needed
  ) %>%
  filter(
    MDV == 0, # filter to observations used in final model
    DOSE != 0
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

INH_PD_nm$DV <- as.numeric(as.character(INH_PD_nm$DV))
INH_sum_PD <- sumPD_median(INH_PD_nm)

# adjust breakII to 1, 7 or 28 for best x-axis breaks
# adjust start_treatment to day of the start if treatment
INHplotPD <- plotPD2(INH_PD_nm, INH_sum_PD, 28, 14)+geom_vline(xintercept = 0, linetype = 2)+scale_x_continuous(breaks = seq(-56, 64, 14))

INHplotPD # Check plots and make appropriate adjustments

EBA_team <- c(
  "#42B1AF",
  "#D12831",
  "#737478",
  "#FCC522",
  "#A6CEE3", "#B2DF8A","#FB9A99","#FDBF6F", "#CAB2D6", "#FFFF99",
   "#1F78B4", "#33A02C", # "#E31A1C",
    "#FF7F00", "#6A3D9A", "#B15928"
)
```


###PZA
Might need to consider dropping some studies to provide only overview plot
```{r message=FALSE, warning=FALSE, echo=FALSE}
# copy dataset into following directory

# change nm dataset csv file to drug_PD_nm.csv if possible
PZA_PD_nm <- read.csv("../data/raw_data/PD/PZA/BalbC_allbaseline_MONO_NONMEM_06122019_BASELINE.csv", header = TRUE, sep =",", as.is=TRUE, na.strings=".") %>%
  mutate(
    DRUG = "PZA",
    ID = ID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIMAST,
    DV = LOGDV,
    DOSE = DOSEZ,
    GROUP = STUDY # change if other grouping for median is needed
  ) %>%
  filter(
    MDV == 0, # filter to observations used in final model
    DOSE != 0
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

PZA_PD_nm$DV <- as.numeric(as.character(PZA_PD_nm$DV))
PZA_sum_PD <- sumPD_median(PZA_PD_nm)

# adjust breakII to 1, 7 or 28 for best x-axis breaks
# adjust start_treatment to day of the start if treatment
PZAplotPD <- plotPD2(PZA_PD_nm, PZA_sum_PD, 28, 14)+geom_vline(xintercept = 0, linetype = 2)+scale_x_continuous(breaks = seq(-56, 64, 14))

PZAplotPD # Check plots and make appropriate adjustments

```

###LZD
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PD/LZD/")

# change nm dataset csv file to drug_PD_nm.csv if possible
LZD_PD_nm <- read_csv("LZD_PD_nm_v2.csv", skip = 0) %>%
  mutate(
    DRUG = "LZD",
    ID = ID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIMAST,
    DV = LOGDV,
    DOSE = Total_Dosa,
    GROUP = Total_Dosa # change if other grouping for median is needed
  ) %>%
  filter(
    MDV == 0 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

LZD_PD_nm$DV <- as.numeric(as.character(LZD_PD_nm$DV))
LZD_sum_PD <- sumPD_median(LZD_PD_nm)

# adjust breakII to 1, 7 or 28 for best x-axis breaks
# adjust start_treatment to day of the start if treatment
LZDplotPD <- plotPD(LZD_PD_nm, LZD_sum_PD, 7, 0)+geom_vline(xintercept = 0, linetype = 2)+scale_x_continuous(breaks = c(-6, 0, 7, 14, 21, 28))

LZDplotPD # Check plots and make appropriate adjustments
```

###MFX
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PD/MFX/")

# change nm dataset csv file to drug_PD_nm.csv if possible
MFX_PD_nm <- read_csv("MOX.PD.NM.csv", skip = 0) %>%
  mutate(
    DRUG = "MFX",
    ID = ID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIMAST,
    DV = LOGDV,
    DOSE = DOSEM,
    GROUP = DOSE # change if other grouping for median is needed
  ) %>%
  filter(
    MDV == 0 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

MFX_PD_nm$DV <- as.numeric(as.character(MFX_PD_nm$DV))
MFX_sum_PD <- sumPD_median(MFX_PD_nm)
start_treatment=0
# adjust breakII to 1, 7 or 28 for best x-axis breaks
# adjust start_treatment to day of the start if treatment
#MFXplotPD <- plotPD(MFX_PD_nm, MFX_sum_PD, 7, 0)
#MFXplotPD # Check plots and make appropriate adjustments
MFXplotPD<- ggplot(MFX_PD_nm, aes(TIME, DV, color = factor(DOSE), group = ID)) +
    geom_point(shape = 1) +
    stat_summary(geom="line", fun.y = median)+
    #geom_line(data = MFX_sum_PD, aes(TIME, medianCc)) +
    scale_color_manual(values = EBA_team) +
    scale_y_continuous(limits = c(0, 10)) +
    scale_x_continuous(limits = c(-42, NA), breaks = c(-42,-28,-14, -4,0,7,14,28,56,84)) +
    facet_wrap(~DRUG, nrow = 1, scales = "free") +
    #geom_vline(linetype = 2, xintercept = inoculation_day) +
    geom_vline(linetype = 2, xintercept = start_treatment) +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
MFXplotPD
```
###PA824
```{r}
# copy dataset into following directory
setwd("../data/raw_data/PD/PA824/")

# change nm dataset csv file to drug_PD_nm.csv if possible
PA824_PD_nm <- read_csv("PA.PD.NM.csv", skip = 0) %>%
  mutate(
    DRUG = "PA824",
    ID = ID, # assign ID, TIME, DV, DOSE & GROUP
    TIME = TIMAST,
    DV = LOGDV,
    DOSE = DOSEPA,
    GROUP = DOSE # change if other grouping for median is needed
  ) %>%
  filter(
    MDV == 0 # filter to observations used in final model
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

PA824_PD_nm$DV <- as.numeric(as.character(PA824_PD_nm$DV))
PA824_sum_PD <- sumPD_median(PA824_PD_nm)
start_treatment=0
# adjust breakII to 1, 7 or 28 for best x-axis breaks
# adjust start_treatment to day of the start if treatment
#MFXplotPD <- plotPD(MFX_PD_nm, MFX_sum_PD, 7, 0)
#MFXplotPD # Check plots and make appropriate adjustments
PA824plotPD<- ggplot(PA824_PD_nm, aes(TIME, DV, color = factor(DOSE), group = ID)) +
    geom_point(shape = 1) +
    stat_summary(geom="line", fun.y = median)+
    #geom_line(data = MFX_sum_PD, aes(TIME, medianCc)) +
    scale_color_manual(values = EBA_team) +
    scale_y_continuous(limits = c(0, 12), breaks = c(0, 2.5, 5, 7.5, 10)) +
    scale_x_continuous(limits = c(-42, NA), breaks = c(-42,-28,-14, 0,14,28,56,84)) +
    facet_wrap(~DRUG, nrow = 1, scales = "free") +
    #geom_vline(linetype = 2, xintercept = inoculation_day) +
    geom_vline(linetype = 2, xintercept = start_treatment) +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
PA824plotPD
```



###RPT
```{r}

#select all, CMD+SHIFT+C to uncomment
#copy dataset into following directory
setwd("../data/raw_data/PD/RPT/")

#change nm dataset csv file to drug_PD_nm.csv if possible
RPT_PD_nm <- read_csv("RPT_PD_nm.csv", skip = 3) %>%
  filter(
    MDV==0,
    MOUSE == 0        #filter to observations used in final model
  ) %>%
  mutate(
    DRUG = "RPT",
    ID = DOSEKG,      #assign ID, TIME, DV, DOSE & GROUP
    TIME = TAD,
    DV = LOG10CFU,
    DOSE = DOSEKG,
    GROUP = DOSEKG      #change if other grouping for median is needed
  ) %>%
  select(ID, TIME, DV, DOSE, DRUG, GROUP)

RPT_PD_nm$DV <- as.numeric(as.character(RPT_PD_nm$DV))
RPT_sum_PD <- sumPD_median(RPT_PD_nm)

#adjust breakII to 1, 7 or 28 for best x-axis breaks
#adjust start_treatment to day of the start if treatment
# RPTplotPD <- plotPD(RPT_PD_nm, RPT_sum_PD, 7, 0)
# 
# 
# RPTplotPD    #Check plots and make appropriate adjustments

start_treatment = 0

RPTplotPD <- ggplot(RPT_PD_nm, aes(TIME, DV, color = factor(DOSE), group = DOSE)) +
  geom_point(shape = 1) +
  geom_line(data = RPT_sum_PD, aes(TIME, medianCc)) +
  scale_color_manual(values = EBA_team) +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(breaks=c(-41,0,28,56)) +
  facet_wrap(~DRUG, nrow = 1, scales = "free") +
  geom_vline(linetype = 2, xintercept = start_treatment) +
  # geom_vline(linetype = 2, xintercept = inoculation_day) +
  theme_bw() +
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(1, 1, 1, 1),
    legend.direction = "horizontal",
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )
RPTplotPD
```

##Plot final PD data
```{r fig.height=8, fig.width=8}
linearPD <- grid.arrange(
  BDQplotPD,
  DLMplotPD,
  INHplotPD,
  LZDplotPD,
  MFXplotPD,
  PA824plotPD,
  PZAplotPD,
  RIFplotPD,
  RPTplotPD,
  nrow = 3,
  left="Log10 CFU",
  bottom="Time since start of treatment (days)"
)

linearPD

#ggsave(plot = linearPD, "../Manuscript/eba_figures/figure2.pdf", width = 12, height = 12)
```


##Human PK

###BDQ
```{r fig.height=4, fig.width=9}
setwd("../data/PK_simulations/BDQ/")
SIM_1 <- read.csv("BDQ_human_pk_model_v_scaled.csv")



bdq_human_pk <- ggplot(data = SIM_1[SIM_1$ORIGIN=="BDQ human",], aes(x=TIME*24, y = CP))+
  stat_summary(geom="ribbon",fill="#42B1AF",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#42B1AF",fun.y=median)+
  theme_bw()+
  facet_wrap(~DOSE, nrow=1)+
  scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  ggtitle("BDQ")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()) 

bdq_human_pk

ggsave(plot = bdq_human_pk, "../Manuscript/eba_figures/figure1c_bdq.pdf", width = 9, height = 4)
```

###DLM
```{r}
setwd("../data/PK_simulations/DLM/")
simpkpd2 <- read.nm.tables("sdtabDpkpd8b") 
simpkpd2 <- simpkpd2[simpkpd2$MDV==0,]

simpkpd2$IDd[simpkpd2$DOSE == 100] <-  "100 mg" 
simpkpd2$IDd[simpkpd2$DOSE == 200] <-  "200 mg"
simpkpd2$IDd[simpkpd2$DOSE == 300] <-  "300 mg"
simpkpd2$IDd[simpkpd2$DOSE == 400] <-  "400 mg"
simpkpd2$IDd = factor(simpkpd2$IDd, levels=c('100 mg','200 mg','300 mg','400 mg'))

simpkpd2 <- filter(simpkpd2, TIME>0)

dlm_human_pk <- ggplot(data = simpkpd2, aes(x=TIME*24, y = CP))+
  stat_summary(geom="ribbon",fill="#F57F20",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#F57F20",fun.y=median) +
  theme_bw()+
  facet_wrap(~IDd, nrow=1)+
  scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  ggtitle("DLM")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48)) +
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())

dlm_human_pk
ggsave(plot = dlm_human_pk, "../Manuscript/eba_figures/figure1c_dlm.pdf", width = 12, height = 4)
```

###INH
```{r}
#setwd("../data/PK_simulations/INH")
HumanPKmodel<-read_nm_table("../data/PK_simulations/INH/sdtabHPKPD19")

HumanPKmodel<-HumanPKmodel%>%
  #filter(ID<=5)%>%
  filter(EVID==0)%>%
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(CP,prob=0.025,na.rm=T),
            Q2=quantile(CP,prob=0.5,na.rm=T),
            Q3=quantile(CP,prob=0.975,na.rm=T))
 # mutate(DOSE1=paste(as.character(DOSE),"mg"))

dose.labs <- c("9 mg", "18.75 mg", "37.5 mg", "75 mg", "150 mg", "300 mg", "600 mg")
names(dose.labs) <- c("9", "18.75", "37.5", "75", "150","300","600")

inh_human_pk <- ggplot() +
  xlab("Time (Hours)") +
  ylab("INH Conc (ug/mL)") +
  geom_ribbon(data=HumanPKmodel,
              aes(x=TIMEH,ymin=Q1,ymax=Q3),alpha=0.4,fill = "#2078B4") +
  geom_line(data=HumanPKmodel, aes(x=TIMEH,y=Q2,group=DOSE), color = "#2078B4") +
  theme_bw()+
  facet_wrap(~DOSE,  nrow = 1, scales = "free_y") +
  theme_bw()+
  ggtitle("INH")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none")

inh_human_pk

ggsave(plot = inh_human_pk, "../Manuscript/eba_figures/figure1c_inh.pdf", width = 21, height = 4)
```

###LZD
```{r}
lzd_scaled_data <- read.csv("../data/PK_simulations/LZD/scaled_LZD_table.csv")

human_data <- filter(lzd_scaled_data, origin == "LZD human")

lzd_human_pk <- ggplot(human_data, aes(time*24, med, color = origin, fill = origin)) +
  geom_ribbon(aes(ymin = lo, ymax = up), alpha = 0.4, color = NA) +
  geom_line() +
  facet_wrap(~DOSE) +
  scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  scale_x_continuous(breaks = seq(0, 24 * 7, 6), limits = c(0,24)) +
  theme_bw()+
  ggtitle("LZD")+
  scale_color_manual(values = "#FCC522") +
  scale_fill_manual(values = "#FCC522") +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none")

lzd_human_pk

ggsave(plot = lzd_human_pk, "../Manuscript/eba_figures/figure1c_lzd.pdf", width = 6, height = 4)
```

###MFX
```{r}
setwd("../data/PK_simulations/MFX/")
simmpk2 <- read_nm_tables("sdtabMpkpd5e1")
simmpk2<- simmpk2[simmpk2$MDV==0,]

simmpk2 <- filter(simmpk2, TIME>0)

mfx_human_pk <- ggplot(data = simmpk2, aes(x=TIME*24, y = CP))+
  stat_summary(geom="ribbon",fill="#737478",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#737478",fun.y=median)+
  theme_bw()+
   facet_wrap(~DOSE,  nrow = 1, scales = "free_y") +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  ggtitle("MXF")+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())
mfx_human_pk

ggsave(plot = mfx_human_pk, "../Manuscript/eba_figures/figure1c_mfx.pdf", width = 3.5, height = 4)
```

###PA824
```{r}
setwd("../data/PK_simulations/PA824/")

simpk0 <- read_nm_tables("sdtabPAPKPD9a")
simpk0<- simpk0[simpk0$MDV==0,]
#simpk0<-filter(simpk0, TIMEH<=48)

simpk0$IDd[simpk0$ID== 1] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 5] <- "200 mg-2"
simpk0$IDd[simpk0$ID== 9] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 13] <- "200 mg-2"
simpk0$IDd[simpk0$ID== 17] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 21] <- "200 mg-2"
#simpk0$IDd[simpk0$IDd== "NA"] <- "200 mg-1"
simpk0$IDd[simpk0$DOSE == 600] <- "600 mg"
simpk0$IDd[simpk0$DOSE == 1000] <- "1000 mg"
simpk0$IDd[simpk0$DOSE == 1200] <- "1200 mg"
simpk0$IDd[simpk0$DOSE==150] <- "150 mg"
simpk0$IDd[simpk0$DOSE == 100] <- "100 mg"
simpk0$IDd[simpk0$DOSE == 50] <- "50 mg"

simpk0 <- filter(simpk0, TIME >0)

pa824_human_pk <- ggplot(data =simpk0 , aes(x=TIME*24, y = CP))+
  stat_summary(geom="ribbon",fill="#34A048",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#34A048",fun.y=mean)+
  theme_bw()+
   facet_wrap(~DOSE,  nrow = 1, scales = "free_y") +
  ggtitle("PA824")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())

pa824_human_pk

ggsave(plot = pa824_human_pk, "../Manuscript/eba_figures/figure1c_pa824.pdf", width = 21, height = 4)
```

###PZA
```{r}
#setwd("../data/PK_simulations/PZA")
HumanPKmodel<-read_nm_table("../data/PK_simulations/PZA/simtabZ7")

HumanPKmodel<-HumanPKmodel%>%
   mutate(DOSE=paste(as.character(DOSE),"mg"))%>%
  filter(ID>=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(CP,prob=0.025,na.rm=T),
            Q2=quantile(CP,prob=0.5,na.rm=T),
            Q3=quantile(CP,prob=0.975,na.rm=T))
            


pza_human_pk <- ggplot() +
  xlab("Time (hours)") +
  ylab("PZA Conc (ug/mL)") +
  geom_ribbon(data=HumanPKmodel, aes(x=TIMEH,ymin=Q1,ymax=Q3),alpha=0.4, fill = "#FB9A99") +
  geom_line(data=HumanPKmodel, aes(x=TIMEH,y=Q2,group=DOSE), color = "#FB9A99") +
  theme_bw() +
   facet_wrap(~DOSE,  nrow = 1, scales = "free_y") +
  ggtitle("PZA")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())
  
pza_human_pk

ggsave(plot = pza_human_pk, "../Manuscript/eba_figures/figure1c_pza.pdf", width = 3.5, height = 4)
```

###RIF
```{r}
#setwd("../data/PK_simulations/RIF")
HumanPKmodel<-read_nm_table("../data/PK_simulations/RIF/simtabR1")

HumanPKmodel<-HumanPKmodel%>%
  filter(ID<=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(WTBSD,TIMEH)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="human")

dose.labs <- c("600 mg", "1050 mg", "1350 mg", "1650 mg", "1950 mg")
names(dose.labs) <- c("10", "20", "25", "30", "35")


rif_human_pk <- ggplot() +
  xlab("Time (Hours)") +
  ylab("INH Conc (ug/mL)") +
  geom_ribbon(data=HumanPKmodel, aes(x=TIMEH,ymin=Q1,ymax=Q3), fill="#D12831", alpha=0.4) +
  geom_line(data=HumanPKmodel, aes(x=TIMEH,y=Q2,group=WTBSD), color="#D12831") +
  theme_bw() +
  ggtitle("RIF")+
   facet_wrap(~WTBSD,  nrow = 1, scales = "free_y") +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())
  
rif_human_pk

ggsave(plot = rif_human_pk, "../Manuscript/eba_figures/figure1c_rif.pdf", width = 15, height = 4)
```

###RPT

```{r}
#load sim
setwd("../data/EBA_simulations/RPT/")

#knet zero / Sirgel
simPKPD1 <- read_nm_table("sdtabPPKPD08")
simPKPD1 <- simPKPD1 %>%
  filter(MDV==0) %>%
  mutate(IPRED = log10(exp(IPRED)),
         PRED  = log10(exp(IPRED))) %>%
  mutate(IDd   = factor(case_when(DOSE == 300 ~ "300 mg",
                          DOSE == 600 ~ "600 mg",
                          DOSE == 900 ~ "900 mg",
                          DOSE == 1200 ~ "1200 mg"),
                          levels=c('300 mg','600 mg','900 mg','1200 mg'))) %>%  
  group_by(ID) %>%
  mutate(KILL = IPRED - IPRED[1])

rpt_human_pk <- ggplot(data = simPKPD1, aes(x=TIME, y = CP))+
  stat_summary(geom="ribbon",fill="#6B3E98",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#6B3E98",fun.y=median)+
    theme_bw()+
  ggtitle("RPT")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()) 

rpt_human_pk

ggsave(plot = rpt_human_pk, "../Manuscript/eba_figures/figure1c_rpt.pdf", width = 3.5, height = 4)
```
##HUMAN PK SIMP
###BDQ
```{r fig.height=4, fig.width=9}
setwd("../data/PK_simulations/BDQ/")
SIM_1 <- read.csv("BDQ_human_pk_model_v_scaled.csv")



bdq_human_pks <- ggplot(data = subset(SIM_1[SIM_1$ORIGIN=="BDQ human",], DOSE==400), aes(x=TIME*24, y = CP))+
  stat_summary(geom="ribbon",fill="#42B1AF",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#42B1AF",fun.y=median)+
  theme_bw()+
  facet_wrap(~DOSE, nrow=1)+
  scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  ggtitle("BDQ")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()) 

bdq_human_pks
```

###DLM
```{r}
setwd("../data/PK_simulations/DLM/")
simpkpd2 <- read.nm.tables("sdtabDpkpd8b") 
simpkpd2 <- simpkpd2[simpkpd2$MDV==0,]

simpkpd2$IDd[simpkpd2$DOSE == 100] <-  "100 mg" 
simpkpd2$IDd[simpkpd2$DOSE == 200] <-  "200 mg"
simpkpd2$IDd[simpkpd2$DOSE == 300] <-  "300 mg"
simpkpd2$IDd[simpkpd2$DOSE == 400] <-  "400 mg"
simpkpd2$IDd = factor(simpkpd2$IDd, levels=c('100 mg','200 mg','300 mg','400 mg'))

simpkpd2 <- filter(simpkpd2, TIME>0)

dlm_human_pks <- ggplot(data = subset(simpkpd2, DOSE==100), aes(x=TIME*24, y = CP))+
  stat_summary(geom="ribbon",fill="#F57F20",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#F57F20",fun.y=median) +
  theme_bw()+
  facet_wrap(~DOSE, nrow=1)+
  scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  ggtitle("DLM")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48)) +
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())

dlm_human_pks
```

###INH
```{r}
#setwd("../data/PK_simulations/INH")
HumanPKmodel<-read_nm_table("../data/PK_simulations/INH/sdtabHPKPD19")

HumanPKmodel<-HumanPKmodel%>%
  #filter(ID<=5)%>%
  filter(EVID==0)%>%
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(CP,prob=0.025,na.rm=T),
            Q2=quantile(CP,prob=0.5,na.rm=T),
            Q3=quantile(CP,prob=0.975,na.rm=T))
 # mutate(DOSE1=paste(as.character(DOSE),"mg"))

dose.labs <- c("9 mg", "18.75 mg", "37.5 mg", "75 mg", "150 mg", "300 mg", "600 mg")
names(dose.labs) <- c("9", "18.75", "37.5", "75", "150","300","600")

inh_human_pks <- ggplot() +
  xlab("Time (Hours)") +
  ylab("INH Conc (ug/mL)") +
  geom_ribbon(data=subset(HumanPKmodel, DOSE==300),
              aes(x=TIMEH,ymin=Q1,ymax=Q3),alpha=0.4,fill = "#2078B4") +
  geom_line(data=subset(HumanPKmodel, DOSE==300),aes(x=TIMEH,y=Q2,group=DOSE), color = "#2078B4") +
  theme_bw()+
  facet_wrap(~DOSE,  nrow = 1, scales = "free_y") +
  theme_bw()+
  ggtitle("INH")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none")

inh_human_pks

```

###LZD
```{r}
lzd_scaled_data <- read.csv("../data/PK_simulations/LZD/scaled_LZD_table.csv")

human_data <- filter(lzd_scaled_data, origin == "LZD human")

lzd_human_pks <- ggplot(data = subset(human_data, DOSE=="600 QD"), aes(time*24, med, color = origin, fill = origin)) +
  geom_ribbon(aes(ymin = lo, ymax = up), alpha = 0.4, color = NA) +
  geom_line() +
  facet_wrap(~DOSE) +
  scale_x_continuous(breaks = seq(0, 24 * 7, 6), limits = c(0,24)) +
  theme_bw()+
  ggtitle("LZD")+
  scale_color_manual(values = "#FCC522") +
  scale_fill_manual(values = "#FCC522") +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none")

lzd_human_pks

```

###MFX
```{r}
setwd("../data/PK_simulations/MFX/")
simmpk2 <- read_nm_tables("sdtabMpkpd5e1")
simmpk2<- simmpk2[simmpk2$MDV==0,]

simmpk2 <- filter(simmpk2, TIME>0)

mfx_human_pks <- ggplot(data = simmpk2, aes(x=TIME*24, y = CP))+
  stat_summary(geom="ribbon",fill="#737478",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#737478",fun.y=median)+
  theme_bw()+
   facet_wrap(~DOSE,  nrow = 1, scales = "free_y") +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  ggtitle("MXF")+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())
mfx_human_pks

```

###PA824
```{r}
setwd("../data/PK_simulations/PA824/")

simpk0 <- read_nm_tables("sdtabPAPKPD9a")
simpk0<- simpk0[simpk0$MDV==0,]
#simpk0<-filter(simpk0, TIMEH<=48)

simpk0$IDd[simpk0$ID== 1] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 5] <- "200 mg-2"
simpk0$IDd[simpk0$ID== 9] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 13] <- "200 mg-2"
simpk0$IDd[simpk0$ID== 17] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 21] <- "200 mg-2"
#simpk0$IDd[simpk0$IDd== "NA"] <- "200 mg-1"
simpk0$IDd[simpk0$DOSE == 600] <- "600 mg"
simpk0$IDd[simpk0$DOSE == 1000] <- "1000 mg"
simpk0$IDd[simpk0$DOSE == 1200] <- "1200 mg"
simpk0$IDd[simpk0$DOSE==150] <- "150 mg"
simpk0$IDd[simpk0$DOSE == 100] <- "100 mg"
simpk0$IDd[simpk0$DOSE == 50] <- "50 mg"

simpk0 <- filter(simpk0, TIME >0)

pa824_human_pks <- ggplot(data =subset(simpk0, DOSE==200) , aes(x=TIME*24, y = CP))+
  stat_summary(geom="ribbon",fill="#34A048",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#34A048",fun.y=mean)+
  theme_bw()+
   facet_wrap(~DOSE,  nrow = 1, scales = "free_y") +
  ggtitle("PA-824")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())

pa824_human_pks

```

###PZA
```{r}
#setwd("../data/PK_simulations/PZA")
HumanPKmodel<-read_nm_table("../data/PK_simulations/PZA/simtabZ7")

HumanPKmodel<-HumanPKmodel%>%
   mutate(DOSE=paste(as.character(DOSE),"mg"))%>%
  filter(ID>=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(CP,prob=0.025,na.rm=T),
            Q2=quantile(CP,prob=0.5,na.rm=T),
            Q3=quantile(CP,prob=0.975,na.rm=T))
            


pza_human_pks <- ggplot() +
  xlab("Time (hours)") +
  ylab("PZA Conc (ug/mL)") +
  geom_ribbon(data=HumanPKmodel, aes(x=TIMEH,ymin=Q1,ymax=Q3),alpha=0.4, fill = "#FB9A99") +
  geom_line(data=HumanPKmodel, aes(x=TIMEH,y=Q2,group=DOSE), color = "#FB9A99") +
  theme_bw() +
   facet_wrap(~DOSE,  nrow = 1, scales = "free_y") +
  ggtitle("PZA")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())
  
pza_human_pks

```

###RIF
```{r}
#setwd("../data/PK_simulations/RIF")
HumanPKmodel<-read_nm_table("../data/PK_simulations/RIF/simtabR1")

HumanPKmodel<-HumanPKmodel%>%
  filter(ID<=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(WTBSD,TIMEH)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="human")

dose.labs <- c("600 mg", "1050 mg", "1350 mg", "1650 mg", "1950 mg")
names(dose.labs) <- c("10", "20", "25", "30", "35")


rif_human_pks <- ggplot() +
  xlab("Time (Hours)") +
  ylab("INH Conc (ug/mL)") +
  geom_ribbon(data=subset(HumanPKmodel, WTBSD==10), aes(x=TIMEH,ymin=Q1,ymax=Q3), fill="#D12831", alpha=0.4) +
  geom_line(data=subset(HumanPKmodel, WTBSD==10), aes(x=TIMEH,y=Q2,group=WTBSD), color="#D12831") +
  theme_bw() +
  ggtitle("RIF")+
   facet_wrap(~WTBSD,  nrow = 1, scales = "free_y") +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())
  
rif_human_pks

```

###RPT

```{r}
#load sim
setwd("../data/EBA_simulations/RPT/")

#knet zero / Sirgel
simPKPD1 <- read_nm_table("sdtabPPKPD08")
simPKPD1 <- simPKPD1 %>%
  filter(MDV==0) %>%
  mutate(IPRED = log10(exp(IPRED)),
         PRED  = log10(exp(IPRED))) %>%
  mutate(IDd   = factor(case_when(DOSE == 300 ~ "300 mg",
                          DOSE == 600 ~ "600 mg",
                          DOSE == 900 ~ "900 mg",
                          DOSE == 1200 ~ "1200 mg"),
                          levels=c('300 mg','600 mg','900 mg','1200 mg'))) %>%  
  group_by(ID) %>%
  mutate(KILL = IPRED - IPRED[1])

rpt_human_pks <- ggplot(data = subset(simPKPD1, DOSE==900), aes(x=TIME, y = CP))+
  stat_summary(geom="ribbon",fill="#6B3E98",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", color="#6B3E98",fun.y=median)+
    theme_bw()+
  ggtitle("RPT")+
  facet_wrap(~DOSE)+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  #coord_cartesian(xlim = c(0,48))+
  #xlim(0,48)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()) 

rpt_human_pks

```

```{r fig.height=8, fig.width=8}
humanPK <- grid.arrange(
  bdq_human_pks,
  dlm_human_pks,
  inh_human_pks,
  lzd_human_pks,
  mfx_human_pks,
  pa824_human_pks,
  pza_human_pks,
  rif_human_pks,
  rpt_human_pks,
  nrow = 3,
  left="Concentration (mg/L)",
  bottom="Time (hours)"
)

humanPK

ggsave(plot = humanPK, "../Manuscript/eba_figures/figure1c.pdf", width = 12, height = 12)
```

##Human PD

###BDQ
```{r}
#load lit data
DR_BDQ <- read.csv("../data/EBA_simulations/BDQ/BDQ-DiaconRustojmee.csv",header=TRUE, skip=5)
names(DR_BDQ) <- c("TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(DR_BDQ)[8:22])
DR_BDQ$SD <- as.numeric(paste(DR_BDQ$SD))

DR_BDQ <- DR_BDQ %>%
  mutate(IDd   = factor(case_when(DOSE == 25 ~ "25 mg",
                          DOSE == 100 ~ "100 mg",
                          DOSE == 400 ~ "400 mg"), 
                          levels=c('25 mg','100 mg','400 mg')))

DR_BDQ$IDd[DR_BDQ$DOSE == 25] <-  "25 mg" 
DR_BDQ$IDd[DR_BDQ$DOSE == 100] <-  "100 mg" 
DR_BDQ$IDd[DR_BDQ$DOSE == 400] <-  "400 mg"
DR_BDQ$IDd = factor(DR_BDQ$IDd, levels=c('25 mg','100 mg','400 mg'))

Diacon <- DR_BDQ %>%
  filter(Study == "Diacon") %>%
  mutate(IDd   = factor(case_when(DOSE == 100 ~ "100 mg",
                          DOSE == 200 ~ "200 mg",
                          DOSE == 300 ~ "300 mg",
                          DOSE == 400 ~ "400 mg"), 
                          levels=c('100 mg','200 mg', '300 mg', '400 mg')))

#visualize lit data
#subset(DR_BDQ, Study=="Rustomjee" & log.CFU != 0)
bdq_human_pd <- ggplot(data = DR_BDQ, aes(x = TIME, y = log.CFU, group=ID, color = factor(DOSE)))+
  theme_bw() + 
  geom_point(shape = 1) +
  geom_line()+
  scale_color_manual(values=EBA_team)+
  scale_x_continuous(breaks = c(0,7,14)) +
  geom_errorbar(data=DR_BDQ, aes(x=TIME, y=log.CFU,ymin=log.CFU-SD, ymax=log.CFU+SD), width=.01)+
  labs(x = "Time (Days)", y = "-log10 Bacterial Kill") +
  ggtitle("BDQ")+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

bdq_human_pd
```

###DLM
```{r}
setwd("../data/eba_simulations/DLM/")


DiaconDLM <- read.csv("DLM-Diacon.csv",header=TRUE, skip=2)
names(DiaconDLM) <- c("TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(DiaconDLM)[8:20])

#DiaconDLM$IDd[DiaconDLM$DOSE == 100] <-  "100 mg" 
#DiaconDLM$IDd[DiaconDLM$DOSE == 200] <-  "200 mg"
#DiaconDLM$IDd[DiaconDLM$DOSE == 300] <-  "300 mg"
#DiaconDLM$IDd[DiaconDLM$DOSE == 400] <-  "400 mg"
#DiaconDLM$IDd = factor(DiaconDLM$IDd, levels=c('100 mg','200 mg','300 mg','400 mg'))


dlm_human_pd <- ggplot(DiaconDLM, aes(TIME, log.CFU, color=as.factor(DOSE))) +
    geom_errorbar(data = DiaconDLM, aes(x = TIME, y = log.CFU, ymin = log.CFU-SD, ymax = log.CFU+SD), width=.01) +
  geom_line() +
  scale_x_continuous(breaks = seq(0, 1 * 14, 7)) +
    geom_point(shape = 1) +
  labs(x = "Time (days)", y = "Log10 CFU") +
  scale_color_manual(values = EBA_team)+
  theme_bw() +
  ggtitle("DLM")+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

dlm_human_pd 
```

###INH
```{r}
donaldinh <- read.csv("../data/eba_simulations/INH/INH-Donald.csv",header=TRUE, skip=2)

donaldinh<-donaldinh%>%
  mutate(DOSE1=paste(as.character(DOSE),"mg"))

dose.labs <- c("9 mg", "18.75 mg", "37.5 mg", "75 mg", "150 mg", "300 mg", "600 mg")
names(dose.labs) <- c("9", "18.75", "37.5", "75", "150","300","600")

#time vs effect in human
inh_human_pd <- ggplot(donaldinh,aes(x=TIME,y=log10cfu, color = factor(DOSE)))+
  geom_point(shape=1) +
  geom_line()+
  scale_color_manual(values = EBA_team) +
  scale_x_continuous( breaks=seq(0,14,1)) +
  ggtitle("INH")+
  theme_bw()+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

inh_human_pd
```

###LZD
```{r}
DietzeLZD <- read.csv("../data/eba_simulations/LZD/LZD-Dietze.csv", header = TRUE, skip = 2)
names(DietzeLZD) <- c("TIME", "KILL", "BASELINE", "log.CFU", "SD", "Study", "DOSE", names(DietzeLZD)[8:23])

DietzeLZD <- DietzeLZD %>%
  mutate(Drug = "LZD")

lzd_human_pd <- ggplot(DietzeLZD, aes(TIME, log.CFU, color = DOSE)) +
  geom_line() +
  geom_point(shape=1) +
  scale_x_continuous(breaks = seq(0, 1 * 7, 7)) +
  geom_errorbar(data = DietzeLZD, aes(x = TIME, y = log.CFU, ymin = log.CFU-SD, ymax = log.CFU+SD), width=0.001) +
  labs(x = "Time (days)", y = "Log10 CFU") +
  scale_color_manual(values = EBA_team)+
  ggtitle("LZD")+
  theme_bw()+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

lzd_human_pd
```

###MFX
```{r}
setwd("../data/eba_simulations/MFX/")
mxf <- read.csv("MXF-2.csv",header=TRUE, skip=2)
names(mxf) <- c("TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(mxf)[8:13])
mxf$IDd[mxf$Study=="Johnson"] <-  "Johnson 400 mg" 
mxf$IDd[mxf$Study=="Pletz"] <-  "Pletz 400 mg" 
mxf$IDd[mxf$Study=="Gosling"] <-  "Goslins 400 mg" 


mfx_human_pd <- ggplot(mxf, aes(TIME, log.CFU, color=(IDd))) +
  geom_line() +
  geom_point(shape = 1) +
  scale_x_continuous(breaks = seq(0, 1 * 14, 7)) +
  geom_errorbar(data = mxf, aes(x = TIME, y = log.CFU, ymin = log.CFU-SD, ymax = log.CFU+SD), width = 0.001) +
  labs(x = "Time (days)", y = "Log10 CFU") +
  scale_color_manual(values = EBA_team)+
  theme_bw() +
  ggtitle("MFX")+
  theme_bw()+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

mfx_human_pd
```

###PA824
```{r}
setwd("../data/eba_simulations/PA824/")

DiaconPA <- read.csv("PA-Diacon2.csv", skip = 2, header = T)
names(DiaconPA) <- c("ID","TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(DiaconPA)[9:22])

DiaconPA$DOSE <- as.numeric(DiaconPA$DOSE)

DiaconPA <- DiaconPA %>% arrange(DOSE)

DiaconPA$IDd[DiaconPA$ID== 1] <- "200 mg-1"
DiaconPA$IDd[DiaconPA$ID== 8] <- "200 mg-2"
DiaconPA$IDd[DiaconPA$DOSE == 600] <- "600 mg"
DiaconPA$IDd[DiaconPA$DOSE == 1000] <- "1000 mg"
DiaconPA$IDd[DiaconPA$DOSE == 1200] <- "1200 mg"
DiaconPA$IDd[DiaconPA$DOSE==150] <- "150 mg"
DiaconPA$IDd[DiaconPA$DOSE == 100] <- "100 mg"
DiaconPA$IDd[DiaconPA$DOSE == 50] <- "50 mg"

pa824_human_pd <- ggplot(DiaconPA, aes(TIME, log.CFU, color=as.factor(IDd))) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = seq(0, 1 * 14, 7)) +
  scale_y_continuous(limits = c(NA, 7.1)) +
  #geom_errorbar(data = DiaconPA, aes(x = TIME, y = log.CFU, ymin = log.CFU-SD, ymax = log.CFU+SD), width = 0.001) +
  labs(x = "Time (days)", y = "Log10 CFU") +
  scale_color_manual(values = EBA_team)+
  ggtitle("PA824")+
  theme_bw()+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

pa824_human_pd
```

###PZA
```{r}

litdata <- read.csv("../data/eba_simulations/PZA/PZAData.csv", header=TRUE, skip =2)
 names(litdata) <- c("TIME","KILL","BASELINE","log.CFU","Study","Dose","EBA02", "EBA214","ID")
 
 litdata<-litdata%>%
   filter((ID>0&Study=="Jindani"))%>%
   rename(STARTCFULOG=BASELINE)%>%
   group_by(TIME)%>%
   mutate(CFU=mean(log.CFU),sd=sd(log.CFU))
   

 pza_human_pd <- ggplot(data=litdata,aes(x=TIME,y=CFU, color = factor(Dose)))+
   geom_point(shape = 1) +
   geom_errorbar(aes(x=TIME, ymin=CFU+sd, ymax=CFU-sd), width=0.001) +
   scale_x_continuous(breaks = seq(0, 1 * 14, 7)) +
   geom_line() +
   scale_color_manual(values = EBA_team) +
   ggtitle("PZA") +
   theme_bw() +
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
 
pza_human_pd 
```

###RIF
```{r}
boeree_all <- read.csv("../data/eba_simulations/RIF/Boeree for R_alldose.csv", header=TRUE, skip =2)
names(boeree_all) <- c("TIME","KILL","BASELINE","log.CFU","WTBSD","Study","KillLB","KillUB","DOSE")

boeree_all <- boeree_all%>%
  mutate(DOSE=paste(as.character(DOSE),"mg"))


#time vs effect in human
rif_human_pd <- ggplot(data=boeree_all, aes(x=TIME,y=log.CFU, color = DOSE))+
  geom_errorbar(data=boeree_all, mapping=aes(x=TIME, ymin=BASELINE+KillUB, ymax=BASELINE+KillLB), width=0.001) + 
  geom_line()+
  geom_point(shape=1) +
  scale_color_manual(values=EBA_team) +
  scale_x_continuous(breaks = seq(0, 1 * 14, 7)) +
  ggtitle("RIF")+
  theme_bw() +
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

rif_human_pd
```

###RPT

```{r}
sirgelrpt <- read.csv("../data/EBA_simulations/RPT/RPT-Sirgel.csv",
                      header=TRUE, skip=2) %>%
    mutate(Dose   = factor(case_when(Dose == 300 ~ "300 mg",
                          Dose == 600 ~ "600 mg",
                          Dose == 900 ~ "900 mg",
                          Dose == 1200 ~ "1200 mg"),
                          levels=c('300 mg','600 mg','900 mg','1200 mg')))
names(sirgelrpt)
rpt_human_pd <- ggplot(data = sirgelrpt, aes(x = TIME, y = log10cfu, group=Dose, color = factor(Dose)))+
  geom_point() +
  geom_line()+
  scale_color_manual(values=EBA_team)+
  scale_x_continuous(breaks = seq(0, 1 * 14, 1)) +
  labs(x = "Time (Days)", y = "-log10 Bacterial Kill") +
  ggtitle("RPT")+
  theme_bw() +
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = c(.99, .99),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(1, 1, 1, 1),
      legend.direction = "horizontal",
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

rpt_human_pd
```

```{r fig.height=8, fig.width=8}
humanPD <- grid.arrange(
  bdq_human_pd,
  dlm_human_pd,
  inh_human_pd,
  lzd_human_pd,
  mfx_human_pd,
  pa824_human_pd,
  pza_human_pd,
  rif_human_pd,
  rpt_human_pd,
  nrow = 3,
  left="Log10 CFU",
  bottom="Time since start of treatment (days)"
)

humanPD

ggsave(plot = humanPD, "../Manuscript/eba_figures/figure1d.pdf", width = 12, height = 12)
```
##Combined 4-part plot

#Figure 3: Structural model
#Table 2: PK&PD parameters
#Figure 4: PK& PD VPC plots
## PK VPCs
###BDQ
```{r fig.height=3, fig.width=3}
setwd("../data/vpc_folders/PK/BDQ/vpc_dir006/")

observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"

obs <- read_nm_table(observations_tablefile) %>%
  filter(MDV == 0) 
sim <- read_nm_table(simulations_tablefile) %>%
  filter(MDV == 0)

simSum <- sim %>%
  group_by(TIME) %>%
  summarise(
    medianDV = quantile(DV, prob = 0.5, na.rm = T),
    upDV = quantile(DV, prob = 0.95, na.rm = T),
    lowDV = quantile(DV, prob = 0.05, na.rm = T)
  )


obsSum <- obs %>%
  group_by(TIME) %>%
  summarise(medianDV = median(DV))

BDQ_PK_VPC <- ggplot(simSum, aes(TIME, medianDV)) +
  geom_ribbon(mapping=aes(ymin = simSum$lowDV, ymax = simSum$upDV), 
              alpha = 0.3, size = 0.0001, fill = "#42B1AF") +
  #scale_color_manual(values = EBA_team) +
  #scale_fill_manual(values = EBA_team) +
  geom_line(color = "#42B1AF") +
  ggtitle("BDQ")+
  geom_point(data = obs, aes(TIME, DV), shape = 1) +
  scale_x_continuous(breaks=seq(0,96,24)) +
  labs(x = "Time (h)", y = "Bedaquiline (mg/L)") +
  geom_line(data = obsSum, aes(TIME, medianDV), linetype = 2) +
  scale_y_log10()+
  # facet_wrap(~DOSE, nrow = 1)+
  theme_bw() +
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
  )
BDQ_PK_VPC

ggsave(plot = BDQ_PK_VPC, "../Manuscript/eba_figures/figure2_bdq.pdf", width = 3.5, height = 4)
```
###DLM
```{r fig.height=3, fig.width=3}
setwd("../data/vpc_folders/PK/DLM/vpc_run6/")

observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"

obs <- read_nm_table(observations_tablefile) %>%
  filter(MDV == 0) 

sim <- read_nm_table(simulations_tablefile) %>%
  filter(MDV == 0)

bin_times <- c(0,1,2, 4,6, 8,10, 22,25, 32)

Number_of_bins <- length(bin_times)-1

for(i in Number_of_bins:1){
sim$BIN[sim$TIME <= bin_times[i+1]] <-i
} 

PRED_BIN <- sim %>%
group_by(TIME) %>% # Calculate the PRED per bin
summarize(PREDBIN = median(PRED))

sim <- merge(sim,PRED_BIN)

# Calculate prediction corrected simulated observations (PCDV)
sim$PCDV <- sim$DV *(sim$PREDBIN/sim$PRED)


for(i in Number_of_bins:1){
obs$BIN[obs$TIME <= bin_times[i+1]] <-i
}

## ADD PRED BIN TO OBSERVATIONS
obs <- merge(obs,PRED_BIN)

obs$PCDV <- obs$DV *(obs$PREDBIN/obs$PRED)

sim <-sim %>% 
  mutate(PCDV = ifelse(PCDV<0, 0, PCDV))

simSum <- sim %>%
  group_by(BIN) %>% 
  summarise(medianDV = quantile(PCDV,prob=0.5,na.rm=T),
            upDV = quantile(PCDV,prob=0.95,na.rm=T),
            lowDV = quantile(PCDV,prob=0.05,na.rm=T),
            TIME = median(TIME))

obsSum <- obs %>% 
  group_by(BIN) %>% 
  summarise(medianDV = median(PCDV),
            TIME = median(TIME))

#infectionday = 0
#treatmentday = 6

obsMin <- 0.02 #lowest obs

simSum_adjusted <- simSum %>% 
  mutate(medianDV = ifelse(medianDV<obsMin, obsMin, medianDV),
         lowDV = ifelse(lowDV<obsMin, obsMin, lowDV),
         upDV = ifelse(upDV<obsMin, obsMin, upDV),)

DLM_PK_VPC <-  ggplot(simSum, aes(TIME, medianDV)) +
  geom_ribbon(mapping=aes(ymin = simSum$lowDV, ymax = simSum$upDV), 
              alpha = 0.3, size = 0.0001, fill = "#F57F20") +
  #scale_color_manual(values = EBA_team) +
  #scale_fill_manual(values = EBA_team) +
  geom_line(color = "#F57F20") +
  geom_point(data = obs, aes(TIME, DV), shape = 1) +
  scale_x_continuous(breaks=seq(0,96,6)) +
  scale_y_log10()+
  labs(x = "Time (h)", y = "DLM (mg/L)") +
  geom_line(data = obsSum, aes(TIME, medianDV), linetype = 2) +
  theme_bw() +
  ggtitle("DLM")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
  )

DLM_PK_VPC

DLM_PK_VPC2 <-  ggplot(simSum_adjusted, aes(TIME, medianDV)) +
  geom_ribbon(mapping=aes(ymin = simSum_adjusted$lowDV, ymax = simSum_adjusted$upDV), 
              alpha = 0.3, size = 0.0001, fill = "#F57F20") +
  #scale_color_manual(values = EBA_team) +
  #scale_fill_manual(values = EBA_team) +
  geom_line(color = "#F57F20") +
  geom_point(data = obs, aes(TIME, DV), shape = 1) +
  scale_x_continuous(breaks=seq(0,96,6)) +
  scale_y_log10()+
  labs(x = "Time (h)", y = "DLM (mg/L)") +
  geom_line(data = obsSum, aes(TIME, medianDV), linetype = 2) +
  theme_bw() +
  ggtitle("DLM")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
  )

DLM_PK_VPC2

#ggsave(plot = DLM_PK_VPC2, "../Manuscript/eba_figures/figure2_dlm.pdf", width = 3.5, height = 4)
```


###RIF
```{r}
library(reshape2)
library(ggplot2)
library(dplyr)
#library(ggplus)
library(xpose4)
working.directory<-'../data/vpc_folders/PK/RIF/vpc18predc/'
#setwd("../data/vpc_folders/PK/RIF/vpc18predc/")

observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(DOSE != 0)
sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(PRED))) %>% 
  filter(DOSE != 0)

simSum <- sim %>%
  group_by(TAD, DOSE) %>% 
  summarise(medianDV = quantile(DV,prob=0.5,na.rm=T),
            upDV = quantile(DV,prob=0.95,na.rm=T),
            lowDV = quantile(DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TAD, DOSE) %>% 
  summarise(medianDV = median(DV))

#infectionday = 0
#treatmentday = 6

RIF_PK_VPC_startified <- ggplot() +
  geom_ribbon(data = simSum, aes(x=TAD, ymin = simSum$lowDV, ymax = simSum$upDV, fill=factor(DOSE), color = factor(DOSE)), alpha = 0.3, linetype = "blank")+
  geom_line(data = simSum, aes(x=TAD, y=medianDV)) +
  geom_point(data = obs, aes(x=TAD, y=DV, color=factor(DOSE))) +
  scale_x_continuous(limits=c(0,24), breaks = seq(0, 48, 4))+
  labs(x = "Time after Dose (hours)", y = "Rifampin Conc (ug/mL)")+
  guides(colour = guide_legend(title = "Dose (mg/kg)"),fill = FALSE)  +
  ggtitle("RIF PK VPC")  + 
  #geom_vline(xintercept = c(infectionday, treatmentday), linetype = 3)+
  scale_color_manual(values = EBA_team)+
  scale_fill_manual(values = EBA_team)+
  geom_line(data = obsSum, aes(TAD, medianDV), linetype = 2)+
  facet_wrap(~DOSE, nrow = 1,scales = "free_y")+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(legend.position="bottom")

RIF_PK_VPC_startified

```

```{r fig.height=3, fig.width=3}
library(reshape2)
library(ggplot2)
library(dplyr)
#library(ggplus)
library(xpose4)
working.directory<-'../data/vpc_folders/PK/RIF/vpc18predc/'
#setwd("../data/vpc_folders/PK/RIF/vpc18predc/")

observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(DOSE != 0)
sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(PRED))) %>% 
  filter(DOSE != 0)

simSum <- sim %>%
  group_by(TAD) %>% 
  summarise(medianDV = quantile(DV,prob=0.5,na.rm=T),
            upDV = quantile(DV,prob=0.95,na.rm=T),
            lowDV = quantile(DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TAD) %>% 
  summarise(medianDV = median(DV))

#infectionday = 0
#treatmentday = 6

RIF_PK_VPC <- ggplot() +
  geom_ribbon(data = simSum, aes(x=TAD, ymin = simSum$lowDV, ymax = simSum$upDV), alpha = 0.3, linetype = "blank", fill = "#D12831")+
  geom_line(data = simSum, aes(x=TAD, y=medianDV), color = "#D12831") +
  geom_point(data = obs, aes(x=TAD, y=DV), shape = 1) +
  scale_x_continuous(limits=c(0,24), breaks = seq(0, 48, 4))+
  labs(x = "Time after Dose (hours)", y = "Rifampin Conc (ug/mL)")+
  guides(colour = guide_legend(title = "Dose (mg/kg)"),fill = FALSE)  +
  #ggtitle("RIF PK VPC")  + 
  #geom_vline(xintercept = c(infectionday, treatmentday), linetype = 3)+
  scale_color_manual(values = EBA_team)+
  scale_fill_manual(values = EBA_team)+
  geom_line(data = obsSum, aes(TAD, medianDV), linetype = 2)+
  theme_bw()+
  ggtitle("RIF")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
  )

RIF_PK_VPC

ggsave(plot = RIF_PK_VPC, "../Manuscript/eba_figures/figure2_rif.pdf", width = 3.5, height = 4)

```

###INH
```{r}
library(reshape2)
library(ggplot2)
library(dplyr)
#library(ggplus)
library(xpose4)
working.directory<-'../data/vpc_folders/PK/INH/vpc15predc/'

observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(DOSE != 0)
sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(PRED))) %>% 
  filter(DOSE != 0)

simSum <- sim %>%
  group_by(TAD, DOSE) %>% 
  summarise(medianDV = quantile(DV,prob=0.5,na.rm=T),
            upDV = quantile(DV,prob=0.95,na.rm=T),
            lowDV = quantile(DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TAD, DOSE) %>% 
  summarise(medianDV = median(DV))

#infectionday = 0
#treatmentday = 6

INH_PK_VPC_stratified <- ggplot() +
  geom_ribbon(data = simSum, aes(x=TAD, ymin = simSum$lowDV, ymax = simSum$upDV, fill=factor(DOSE), color = factor(DOSE)), alpha = 0.3, linetype = "blank")+
  geom_line(data = simSum, aes(x=TAD, y=medianDV)) +
  geom_point(data = obs, aes(x=TAD, y=DV, color=factor(DOSE))) +
  scale_x_continuous(limits=c(0,10),breaks = seq(0, 24, 2))+
  labs(x = "Time after Dose (hours)", y = "INH Conc (ug/mL)")+
  guides(colour = guide_legend(title = "Dose (mg/kg)"),fill = FALSE)  +
  ggtitle("INH PK VPC")  + 
  #geom_vline(xintercept = c(infectionday, treatmentday), linetype = 3)+
  scale_color_manual(values = EBA_team)+
  scale_fill_manual(values = EBA_team)+
  geom_line(data = obsSum, aes(TAD, medianDV), linetype = 2)+
  facet_wrap(~DOSE, nrow = 1,scales = "free_y")+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(legend.position="bottom")

INH_PK_VPC_stratified



```

```{r fig.height=3, fig.width=3}
library(reshape2)
library(ggplot2)
library(dplyr)
#library(ggplus)
library(xpose4)
working.directory<-'../data/vpc_folders/PK/INH/vpc15predc/'

observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(DOSE != 0)
sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(PRED))) %>% 
  filter(DOSE != 0)

simSum <- sim %>%
  group_by(TAD) %>% 
  summarise(medianDV = quantile(DV,prob=0.5,na.rm=T),
            upDV = quantile(DV,prob=0.95,na.rm=T),
            lowDV = quantile(DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TAD) %>% 
  summarise(medianDV = median(DV))

#infectionday = 0
#treatmentday = 6

INH_PK_VPC <- ggplot() +
  geom_ribbon(data = simSum, aes(x=TAD, ymin = simSum$lowDV, ymax = simSum$upDV), alpha = 0.3, linetype = "blank", fill = "#2078B4")+
  geom_line(data = simSum, aes(x=TAD, y=medianDV), color = "#2078B4") +
  geom_point(data = obs, aes(x=TAD, y=DV), shape =1) +
  scale_x_continuous(limits=c(0,8),breaks = seq(0, 24, 2))+
  labs(x = "Time after Dose (hours)", y = "INH Conc (ug/mL)")+
  guides(colour = guide_legend(title = "Dose (mg/kg)"),fill = FALSE)  +
  #ggtitle("INH PK VPC")  + 
  #geom_vline(xintercept = c(infectionday, treatmentday), linetype = 3)+
  scale_color_manual(values = EBA_team)+
  scale_fill_manual(values = EBA_team)+
  #scale_y_log10()+
  geom_line(data = obsSum, aes(TAD, medianDV), linetype = 2)+
  theme_bw()+
  ggtitle("INH")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
  )

INH_PK_VPC

ggsave(plot = INH_PK_VPC, "../Manuscript/eba_figures/figure2_inh.pdf", width = 3.5, height = 4)

```

###PZA
```{r}
library(reshape2)
library(ggplot2)
library(dplyr)
#library(ggplus)
library(xpose4)

working.directory<-'../data/vpc_folders/PK/PZA/vpc14predc/'


observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(DRUGDOSE != 0)
sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(PRED))) %>% 
  filter(DRUGDOSE != 0)

simSum <- sim %>%
  group_by(TAD, DRUGDOSE) %>% 
  summarise(medianDV = quantile(DV,prob=0.5,na.rm=T),
            upDV = quantile(DV,prob=0.95,na.rm=T),
            lowDV = quantile(DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TAD, DRUGDOSE) %>% 
  summarise(medianDV = median(DV))

#infectionday = 0
#treatmentday = 6

PZA_PK_VPC_stratified <- ggplot() +
  geom_ribbon(data = simSum, aes(x=TAD, ymin = simSum$lowDV, ymax = simSum$upDV, fill=factor(DRUGDOSE), color = factor(DRUGDOSE)), alpha = 0.3, linetype = "blank")+
  geom_line(data = simSum, aes(x=TAD, y=medianDV)) +
  geom_point(data = obs, aes(x=TAD, y=DV, color=factor(DRUGDOSE))) +
  scale_x_continuous(breaks = seq(0, 24, 2))+
  labs(x = "Time after Dose (hours)", y = "PZA Conc (ug/mL)")+
  guides(colour = guide_legend(title = "PZA Dose (mg/kg)"),fill = FALSE)  +
  scale_color_manual(values = EBA_team)+
  scale_fill_manual(values = EBA_team)+
  #ggtitle("PZA PK VPC")  + 
  #geom_vline(xintercept = c(infectionday, treatmentday), linetype = 3)+
  geom_line(data = obsSum, aes(TAD, medianDV), linetype = 2)+
  facet_wrap(~DRUGDOSE, nrow = 1,scales = "free_y")+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(legend.position="bottom")

PZA_PK_VPC_stratified


```

```{r fig.height=3, fig.width=3}
library(reshape2)
library(ggplot2)
library(dplyr)
#library(ggplus)
library(xpose4)

working.directory<-'../data/vpc_folders/PK/PZA/vpc14predc/'


observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(DRUGDOSE != 0)
sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  #mutate(LOG10DV = log10(exp(PRED))) %>% 
  filter(DRUGDOSE != 0)

simSum <- sim %>%
  group_by(TAD) %>% 
  summarise(medianDV = quantile(DV,prob=0.5,na.rm=T),
            upDV = quantile(DV,prob=0.95,na.rm=T),
            lowDV = quantile(DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TAD) %>% 
  summarise(medianDV = median(DV))

#infectionday = 0
#treatmentday = 6

PZA_PK_VPC <- ggplot() +
  geom_ribbon(data = simSum, aes(x=TAD, ymin = simSum$lowDV, ymax = simSum$upDV), alpha = 0.3, linetype = "blank", fill = "#FB9A99")+
  geom_line(data = simSum, aes(x=TAD, y=medianDV), color = "#FB9A99") +
  geom_point(data = obs, aes(x=TAD, y=DV), shape = 1) +
  scale_x_continuous(breaks = seq(0, 24, 2))+
  labs(x = "Time after Dose (hours)", y = "PZA Conc (ug/mL)")+
  guides(colour = guide_legend(title = "PZA Dose (mg/kg)"),fill = FALSE)  +
  scale_color_manual(values = EBA_team)+
  scale_fill_manual(values = EBA_team)+
  #ggtitle("PZA PK VPC")  + 
  #geom_vline(xintercept = c(infectionday, treatmentday), linetype = 3)+
  geom_line(data = obsSum, aes(TAD, medianDV), linetype = 2)+
  theme_bw()+
  ggtitle("PZA")+
  #scale_y_log10()+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
  )

PZA_PK_VPC

ggsave(plot = PZA_PK_VPC, "../Manuscript/eba_figures/figure2_pza.pdf", width = 3.5, height = 4)
```

###LZD
```{r}
bins <- read.csv("../data/vpc_folders/PK/LZD/DV_bins.txt")
obs <- read.csv("../data/vpc_folders/PK/LZD/DV_observations.txt")
pers <- read.csv("../data/vpc_folders/PK/LZD/DV_percentiles.txt")
```

```{r fig.height=3, fig.width=3}
LZD_PK_VPC <- ggplot(pers, aes(bins_middles, theoretical_median_median))+
    geom_ribbon(data = pers, aes(x = bins_middles ,ymin = theoretical_lower_piLower, ymax = theoretical_upper_piUpper), alpha = 0.3, linetype = "blank", fill = "#FCC522")+
  geom_line(color = "#FCC522")+
  geom_line(aes(bins_middles, empirical_median), linetype = 2)+
  #geom_point(data = obs, aes(time, DV_simBlq, shape = factor(censored)))+ #TOOK OUT SHOWING CENSORED DATA
  geom_point(data = obs, aes(time, DV_simBlq), shape = 1)+
  #scale_color_manual(values = EBA_team)+
  #scale_fill_manual(values = EBA_team)+
  scale_x_continuous(breaks = seq(0, 24, 6))+
  scale_shape_manual(values = c(16, 1), name = "BLQ (simulated DV)")+
  labs(x = "Time after dose (hrs)", y = "Log-scaled pred-corr concentration mg/L")+
  scale_y_log10()+
  ggtitle("LZD")+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

LZD_PK_VPC

ggsave(plot = LZD_PK_VPC, "../Manuscript/eba_figures/figure2_lzd.pdf", width = 3.5, height = 4)
```


###MFX
```{r fig.height=3, fig.width=3}
setwd("../data/vpc_folders/PK/MFX/vpc_run2/")

observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"
obs <- read_nm_table(observations_tablefile) %>%
  filter(MDV == 0) 



sim <- read_nm_table(simulations_tablefile) %>%
  filter(MDV == 0) %>% 
  mutate(DV = ifelse(DV<0, 0, DV))



simSum <- sim %>%
  group_by(TIME) %>% 
  summarise(medianDV = quantile(DV,prob=0.5,na.rm=T),
            upDV = quantile(DV,prob=0.95,na.rm=T),
            lowDV = quantile(DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TIME) %>% 
  summarise(medianDV = median(DV))

#infectionday = 0
#treatmentday = 6

obsMin <- 0.04 #second lowest obs lowest is 0

simSum_adjusted <- simSum %>% 
  mutate(medianDV = ifelse(medianDV<obsMin, obsMin, medianDV),
         lowDV = ifelse(lowDV<obsMin, obsMin, lowDV),
         upDV = ifelse(upDV<obsMin, obsMin, upDV),)

MFX_PK_VPC <- ggplot(simSum, aes(TIME, medianDV)) +
  geom_ribbon(mapping=aes(ymin = simSum$lowDV, ymax = simSum$upDV), 
              alpha = 0.3, size = 0.0001, fill = "#737478") +
  geom_line(color = "#737478") +
  geom_point(data = obs, aes(TIME, DV), shape = 1) +
  scale_x_continuous(breaks=seq(0,24,6)) +
  labs(x = "Time (h)", y = "MOX (mg/L)") +
  geom_line(data = obsSum, aes(TIME, medianDV), linetype = 2) +
  scale_y_log10()+
  # facet_wrap(~DOSE, nrow = 1)+
  ggtitle("MFX")+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

MFX_PK_VPC


MFX_PK_VPC2 <- ggplot(simSum_adjusted, aes(TIME, medianDV)) +
  geom_ribbon(mapping=aes(ymin = simSum_adjusted$lowDV, ymax = simSum_adjusted$upDV), 
              alpha = 0.3, size = 0.0001, fill = "#737478") +
  geom_line(color = "#737478") +
  geom_point(data = obs, aes(TIME, DV), shape = 1) +
  scale_x_continuous(breaks=seq(0,24,6)) +
  labs(x = "Time (h)", y = "MOX (mg/L)") +
  geom_line(data = obsSum, aes(TIME, medianDV), linetype = 2) +
  scale_y_log10()+
  # facet_wrap(~DOSE, nrow = 1)+
  ggtitle("MXF")+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

MFX_PK_VPC2

ggsave(plot = MFX_PK_VPC2, "../Manuscript/eba_figures/figure2_mfx.pdf", width = 3.5, height = 4)
```

###PA824
```{r fig.height=3, fig.width=3}
library(reshape2)
library(ggplot2)
library(dplyr)
library(xpose4)

setwd("../data/vpc_folders/PK/PA824/vpc_run223_4_1/")

observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"

obs <- read_nm_table(observations_tablefile) %>%
  filter(MDV == 0) 

sim <- read_nm_table(simulations_tablefile) %>%
  filter(MDV == 0) 



simSum <- sim %>%
  group_by(TAD) %>% 
  summarise(medianDV = quantile(DV,prob=0.5,na.rm=T),
            upDV = quantile(DV,prob=0.95,na.rm=T),
            lowDV = quantile(DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TAD) %>% 
  summarise(medianDV = median(DV))

#infectionday = 0
#treatmentday = 6

PA824_PK_VPC <- ggplot(simSum, aes(TAD, medianDV)) +
  geom_ribbon(mapping=aes(ymin = simSum$lowDV, ymax = simSum$upDV), 
              alpha = 0.3, size = 0.0001, fill = "#34A048") +
  #scale_color_manual(values = EBA_team) +
  #scale_fill_manual(values = EBA_team) +
  geom_line(color = "#34A048") +
  geom_point(data = obs, aes(TAD, DV), shape = 1) +
  scale_x_continuous(breaks=seq(0,96,24)) +
  labs(x = "Time (h)", y = "PA-824 (mg/L)") +
  geom_line(data = obsSum, aes(TAD, medianDV), linetype = 2) +
  scale_y_log10()+
  # facet_wrap(~DOSE, nrow = 1)+
  ggtitle("PA-824")+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

PA824_PK_VPC

ggsave(plot = PA824_PK_VPC, "../Manuscript/eba_figures/figure2_pa824.pdf", width = 3.5, height = 4)
```
###RPT
```{r fig.height=3, fig.width=3}
setwd("../data/vpc_folders/PK/RPT/vpc_dir02/")

observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"

obs <- read_nm_table(observations_tablefile) %>%
  filter(MDV==0) %>%
  mutate(TAD = case_when(
                         ID==51 ~ TIME-384,
                         ID==52 ~ TIME-384,
                         ID==53 ~ TIME-384,
                         ID==61 ~ TIME-335.99,
                         ID==62 ~ TIME-335.99,
                         ID==63 ~ TIME-335.99,
                         ID==71 ~ TIME-335.99,
                         ID==72 ~ TIME-335.99,
                         ID==73 ~ TIME-335.99
                         
  ))

sim <- read_nm_table(simulations_tablefile) %>%
  mutate(TAD = case_when(
                         ID==51 ~ TIME-384,
                         ID==52 ~ TIME-384,
                         ID==53 ~ TIME-384,
                         ID==61 ~ TIME-335.99,
                         ID==62 ~ TIME-335.99,
                         ID==63 ~ TIME-335.99,
                         ID==71 ~ TIME-335.99,
                         ID==72 ~ TIME-335.99,
                         ID==73 ~ TIME-335.99)) %>%
    filter(MDV == 0,
         TAD != 72)

simSum <- sim %>%
  group_by(TAD) %>%
  summarise(
    medianDV = quantile(DV, prob = 0.5, na.rm = T),
    upDV = quantile(DV, prob = 0.95, na.rm = T),
    lowDV = quantile(DV, prob = 0.05, na.rm = T) )

obsSum <- obs %>%
  group_by(TAD) %>%
  summarise(medianDV = median(DV)) 

simSum$lowDV[simSum$lowDV<0]<-0

RPT_PK_VPC <- ggplot(simSum, aes(TAD, medianDV)) +
  geom_ribbon(mapping=aes(ymin = simSum$lowDV, ymax = simSum$upDV), 
              alpha = 0.3, size = 0.0001, fill = "#6B3E98") +
  scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  geom_line(color = "#6B3E98") +
  geom_point(data = obs, aes(TAD, DV), shape = 1) +
  #scale_x_continuous(breaks=seq(0,96,24)) +
  labs(x = "Time (h)", y = "Rifapentine (mg/L)") +
  geom_line(data = obsSum, aes(TAD, medianDV), linetype = 2) +
  scale_x_continuous(breaks = seq(0, 196, 24))+
  scale_y_log10()+
  #facet_wrap(~DOSE, nrow = 1)+
  ggtitle("RPT")+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )
RPT_PK_VPC

ggsave(plot = RPT_PK_VPC, "../Manuscript/eba_figures/figure2_rpt.pdf", width = 3.5, height = 4)
```

#!!!ERROR
##Final PK VPC combined
```{r}
grid.arrange(BDQ_PK_VPC,
             #DLM_PK_VPC,
             #RIF_PK_VPC,
             #INH_PK_VPC#,
             #PZA_PK_VPC#,
             LZD_PK_VPC,#,
             #MFX_PK_VPC,
             #PA824_PK_VPC,
             RPT_PK_VPC
             )
```


```{r}
#ggsave(plot = BDQ_PK_VPC, "../Manuscript/eba_figures/figure2_bdq.pdf", width = 3.5, height = 4)
#ggsave(plot = DLM_PK_VPC2, "../Manuscript/eba_figures/figure2_dlm.pdf", width = 3.5, height = 4)
#ggsave(plot = INH_PK_VPC, "../Manuscript/eba_figures/figure2_inh.pdf", width = 3.5, height = 4)
#ggsave(plot = LZD_PK_VPC, "../Manuscript/eba_figures/figure2_lzd.pdf", width = 3.5, height = 4)
#ggsave(plot = MFX_PK_VPC2, "../Manuscript/eba_figures/figure2_mfx.pdf", width = 3.5, height = 4)
#ggsave(plot = PA824_PK_VPC, "../Manuscript/eba_figures/figure2_pa824.pdf", width = 3.5, height = 4)
#ggsave(plot = PZA_PK_VPC, "../Manuscript/eba_figures/figure2_pza.pdf", width = 3.5, height = 4)
#ggsave(plot = RIF_PK_VPC, "../Manuscript/eba_figures/figure2_rif.pdf", width = 3.5, height = 4)
#ggsave(plot = RPT_PK_VPC, "../Manuscript/eba_figures/figure2_rpt.pdf", width = 3.5, height = 4)
```


## PD VPC
###BDQ
```{r fig.height=2.5, fig.width=6}
setwd("../data/vpc_folders/PD/BDQ/vpc_dir28a/")

observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"

obs <- read_nm_table(observations_tablefile) %>%
  filter(MDV==0) %>%
  mutate(LOG10DV = log10(exp(DV)))

sim <- read_nm_table(simulations_tablefile) %>%
  filter(MDV==0) %>%
  mutate(LOG10DV = log10(exp(DV)))

simSum <- sim %>%
  group_by(TIME,DOSE) %>%
  summarise(
    medianDV = quantile(DV, prob = 0.5, na.rm = T),
    upDV = quantile(DV, prob = 0.95, na.rm = T),
    lowDV = quantile(DV, prob = 0.05, na.rm = T) )


obsSum <- obs %>%
  group_by(TIME,DOSE) %>%
  summarise(medianDV = median(DV)) 

 treatmentday = 14

BDQ_PD_VPC <- ggplot(simSum, aes(TIME, medianDV)) +
  geom_ribbon(aes(ymin = simSum$lowDV, ymax = simSum$upDV), alpha = 0.3, linetype="blank", fill = "#42B1AF")+# size = 0.0001)) +
  scale_x_continuous(breaks = c(1,14,42,70),
                     labels = c(-13,0,28,56))+
  geom_line(color = "#42B1AF") +
  geom_point(data = obs, aes(TIME, DV), shape = 1) +
  #scale_x_continuous(breaks = seq(0, 500, 7)) +
  ylim(NA,25)+
  labs(x = "Time Since Treatment (days)", y = "log10 CFU") +
  geom_vline(xintercept = treatmentday, linetype = 2)+
  geom_line(data = obsSum, aes(TIME, medianDV), linetype = 2) +
  #scale_y_log10()+
  #facet_wrap(~DOSE, nrow = 1)+
  theme_bw() +
  ggtitle("BDQ")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

BDQ_PD_VPC_facet <-BDQ_PD_VPC + facet_wrap(~DOSE, nrow=1)
BDQ_PD_VPC_facet
```
###DLM
####SUBACUTE
```{r fig.height=2.5, fig.width=8}
setwd("../data/vpc_folders/PD/DLM/vpc_d6a_1/")
observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% filter(ID!=1000) %>%
  mutate(LOG10DV = log10(exp(DV))) 

obs$IDd[obs$ID==1001] <-3
obs$IDd [obs$ID==1002]<-10
obs$IDd[obs$ID==1003] <-30
obs$IDd[obs$ID==1004] <-100

sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% filter(ID!=1000)%>%
  mutate(LOG10DV = log10(exp(DV))) 

sim$IDd[sim$ID==1001] <- 3
sim$IDd[sim$ID==1002] <- 10
sim$IDd [sim$ID==1003]<- 30
sim$IDd [sim$ID==1004]<- 100

sim$IDd <- as.numeric(sim$IDd)
obs$IDd<- as.numeric(obs$IDd)
simSum <- sim %>%
  group_by(TIMAST, IDd) %>% 
  summarise(medianDV = quantile(LOG10DV,prob=0.5,na.rm=T),
            upDV = quantile(LOG10DV,prob=0.95,na.rm=T),
            lowDV = quantile(LOG10DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TIMAST, IDd) %>% 
  summarise(medianDV = median(LOG10DV))

#infectionday = 0
treatmentday = 0
ggplot()+
  geom_ribbon(data=simSum,aes(x=TIMAST, ymin = simSum$lowDV, ymax = simSum$upDV), alpha = 0.3, fill = "#F57F20") +
  geom_line(data=simSum,aes(x=TIMAST, y=medianDV, group=factor(IDd)), color = "#F57F20") +
  geom_point(data = obs, aes(x=TIMAST, y=LOG10DV), shape = 1) +
  scale_x_continuous(limits=c(-14,14), breaks = seq(-140, 500, 7))+
  scale_y_continuous(limits=c(0, 9), breaks = seq(0,8,2)) +
  labs(x = "Time Since Treatment (days)", y = "log10 CFU/mL")+
  ggtitle("VPC of DLM PD Model with Sub-acute Infection")  + 
  geom_vline(xintercept = treatmentday, linetype = 2)+
  geom_line(data = obsSum, aes(x=TIMAST, y=medianDV, group=factor(IDd)), linetype = 2)+
  #facet_wrap(~DOSER, nrow = 1)+
  theme_bw()+
  facet_grid(~IDd)+
  theme(strip.background = element_rect(fill = NA, color = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  guides(colour = guide_legend(title = "Dose (mg/kg)"), fill= guide_legend(title = "Dose (mg/kg)"))  +
  ggtitle("DLM")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

```

###RIF 
####ACUTE
```{r fig.height=2.5, fig.width=4}
library(reshape2)
library(ggplot2)
library(dplyr)
#library(ggplus)
library(xpose4)
working.directory<-'../data/vpc_folders/PD/RIF/vpc163predc/'

observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(STUDY==43) %>%
  filter(DOSER==0|DOSER==10|DOSER==40)

sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(STUDY==43) %>%
  filter(DOSER==0|DOSER==10|DOSER==40)

simSum <- sim %>%
  group_by(STUDY, DOSER, TIMAST) %>% 
  summarise(medianDV = quantile(LOG10DV,prob=0.5,na.rm=T),
            upDV = quantile(LOG10DV,prob=0.95,na.rm=T),
            lowDV = quantile(LOG10DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(STUDY, DOSER, TIMAST) %>% 
  summarise(medianDV = median(LOG10DV))

#infectionday = 0
treatmentday = 0

a <- ggplot()+
  geom_ribbon(data=simSum,aes(x=TIMAST, ymin = simSum$lowDV, ymax = simSum$upDV), alpha = 0.3, fill = "#D12831") +
  geom_line(data=simSum,aes(x=TIMAST, y=medianDV, group=factor(DOSER)), color = "#D12831") +
  geom_point(data = obs, aes(x=TIMAST, y=LOG10DV), shape = 1) +
  scale_x_continuous(limits=c(-7, 28), breaks = seq(-140, 500, 7))+
    scale_y_continuous(limits=c(0, 9), breaks = seq(0,9,1)) +
  labs(x = "Time Since Treatment (days)", y = "log10 CFU/mL")+
  ggtitle("VPC of RIF PD Model with Acute Infection")  + 
  geom_vline(xintercept = c(treatmentday), linetype = 2)+
  geom_line(data = obsSum, aes(x=TIMAST, y=medianDV, group=factor(DOSER)), linetype = 2)+
  facet_wrap(~DOSER, nrow = 1)+
  theme_bw()+
  ggtitle("RIF")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )



a
```

###INH 
####ACUTE
```{r fig.height=2.5, fig.width=6}
library(reshape2)
library(ggplot2)
library(dplyr)
#library(ggplus)
library(xpose4)
working.directory<-'../data/vpc_folders/PD/INH/vpc243predc/'

observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(STUDY==46, DDOSEH != 0) 

sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(STUDY==46, DDOSEH != 0)

simSum <- sim %>%
  group_by(TIMAST, DDOSEH) %>% 
  summarise(medianDV = quantile(LOG10DV,prob=0.5,na.rm=T),
            upDV = quantile(LOG10DV,prob=0.95,na.rm=T),
            lowDV = quantile(LOG10DV,prob=0.05,na.rm=T)) %>% 
  filter(DDOSEH != 0)

obsSum <- obs %>% 
  group_by(TIMAST, DDOSEH) %>% 
  summarise(medianDV = median(LOG10DV)) %>% 
  filter(DDOSEH != 0)

#infectionday = 0
treatmentday = 0

a <- ggplot()+
  geom_ribbon(data=simSum,aes(x=TIMAST, ymin = simSum$lowDV, ymax = simSum$upDV), fill = "#2078B4",alpha = 0.3 ) +
  geom_line(data=simSum,aes(x=TIMAST, y=medianDV, group=factor(DDOSEH)), color = "#2078B4") +
  geom_point(data = obs, aes(x=TIMAST, y=LOG10DV), shape = 1) +
  scale_x_continuous(limits=c(-7,28), breaks = seq(-140, 500, 7))+
  #scale_y_continuous(limits=c(0, 9), breaks = seq(0,8,2)) +
  labs(x = "Time Since Treatment (days)", y = "log10 CFU/mL")+
  ggtitle("VPC of INH PD Model with Acute Infection")  + 
  geom_vline(xintercept = c(treatmentday), linetype = 2)+
  geom_line(data = obsSum, aes(x=TIMAST, y=medianDV, group=factor(DDOSEH)), linetype = 2)+
  facet_wrap(~DDOSEH, nrow = 1)+
  theme_bw()+
  ggtitle("INH")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

a
```



###PZA 
####ACUTE
```{r fig.height=2.5, fig.width=6}
library(reshape2)
library(ggplot2)
library(dplyr)
#library(ggplus)
library(xpose4)
working.directory<-'../data/vpc_folders/PD/PZA/vpc219predc/'

observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(STUDY==45) %>%
  filter(DOSEZ==0|DOSEZ==150|DOSEZ==900)

sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV))) %>% 
   filter(STUDY==45) %>%
  filter(DOSEZ==0|DOSEZ==150|DOSEZ==900)

simSum <- sim %>%
  group_by(TIMAST, DOSEZ) %>% 
  summarise(medianDV = quantile(LOG10DV,prob=0.5,na.rm=T),
            upDV = quantile(LOG10DV,prob=0.95,na.rm=T),
            lowDV = quantile(LOG10DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TIMAST, DOSEZ) %>% 
  summarise(medianDV = median(LOG10DV))

#infectionday = 0
treatmentday = 0

a <- ggplot()+
  geom_ribbon(data=simSum,aes(x=TIMAST, ymin = simSum$lowDV, ymax = simSum$upDV), fill = "#FB9A99", alpha = 0.3 ) +
  geom_line(data=simSum,aes(x=TIMAST, y=medianDV, group=factor(DOSEZ)), color = "#FB9A99") +
  geom_point(data = obs, aes(x=TIMAST, y=LOG10DV), shape = 1) +
  scale_x_continuous(limits=c(-7,28), breaks = seq(-140, 500, 7))+
  #scale_y_continuous(limits=c(0, 9), breaks = seq(0,8,2)) +
  labs(x = "Time Since Treatment (days)", y = "log10 CFU/mL")+
  ggtitle("VPC of PZA PD Model with Acute Infection")  + 
  geom_vline(xintercept = c(treatmentday), linetype = 2)+
  geom_line(data = obsSum, aes(x=TIMAST, y=medianDV, group=factor(DOSEZ)), linetype = 2)+
  facet_wrap(~DOSEZ, nrow = 1)+
  theme_bw()+
  ggtitle("PZA")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

a

```


###MFX
####ACUTE
```{r fig.height=2.5, fig.width=4}
setwd("../data/vpc_folders/PD/MFX/vpc_19c_2/")

observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV)))


sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV))) 

simSum <- sim %>%
  group_by(DOSEM, TIMAST) %>% 
  summarise(medianDV = quantile(LOG10DV,prob=0.5,na.rm=T),
            upDV = quantile(LOG10DV,prob=0.95,na.rm=T),
            lowDV = quantile(LOG10DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(DOSEM,TIMAST) %>% 
  summarise(medianDV = median(LOG10DV))

#infectionday = 0
#treatmentday = 0

ggplot()+
  geom_ribbon(data=simSum,aes(x=TIMAST, ymin = simSum$lowDV, ymax = simSum$upDV), fill = "#737478", alpha = 0.3 ) +
  geom_line(data=simSum,aes(x=TIMAST, y=medianDV, group=factor(DOSEM)), color = "#737478") +
  geom_point(data = obs, aes(x=TIMAST, y=LOG10DV), shape = 1) +
  scale_x_continuous()+
  scale_y_continuous() +
  labs(x = "Time Since Treatment (days)", y = "log10 CFU/mL")+
  #geom_vline(xintercept = c(treatmentday), linetype = 2)+
  geom_line(data = obsSum, aes(x=TIMAST, y=medianDV, group=factor(DOSEM)), linetype = 2)+
  facet_wrap(~DOSEM, nrow = 1)+
  theme_bw()+
  ggtitle("MXF")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

```

###PA824
####ACUTE
```{r fig.height=2.5, fig.width=10}
setwd("../data/vpc_folders/PD/PA824/vpc_run27_12/")

observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0)%>% filter(ID==1000|ID==1010|ID==1011|ID==1055|ID==1006)%>%
 mutate(LOG10DV = log10(exp(DV)))
obs$IDd[obs$ID==1000] <- '0'
obs$IDd[obs$ID==1055] <- '12.5'
obs$IDd[obs$ID==1010] <- '25'
obs$IDd[obs$ID==1011] <- '100'
obs$IDd[obs$ID==1006] <- '200'

sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>%filter(ID==1000|ID==1010|ID==1011|ID==1055|ID==1006) %>%
 mutate(LOG10DV = log10(exp(DV))) 
sim$IDd[sim$ID==1000] <-'0'
sim$IDd[sim$ID==1055] <-'12.5'
sim$IDd[sim$ID==1010] <-'25'
sim$IDd[sim$ID==1011] <-'100'
sim$IDd[sim$ID==1006] <-'200'


simSum <- sim %>%
  group_by(IDd, TIMAST) %>% 
  summarise(medianDV = quantile(LOG10DV,prob=0.5,na.rm=T),
            upDV = quantile(LOG10DV,prob=0.95,na.rm=T),
            lowDV = quantile(LOG10DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(IDd,TIMAST) %>% 
  summarise(medianDV = median(LOG10DV))

#infectionday = 0
treatmentday = 6

ggplot()+
  geom_ribbon(data=simSum,aes(x=TIMAST, ymin = simSum$lowDV, ymax = simSum$upDV),fill = "#34A048", alpha = 0.3 ) +
  geom_line(data=simSum,aes(x=TIMAST, y=medianDV, group=factor(IDd)), color = "#34A048") +
  geom_point(data = obs, aes(x=TIMAST, y=LOG10DV), shape = 1) +
  scale_x_continuous()+
  scale_y_continuous() +
  labs(x = "Time Since Treatment (days)", y = "log10 CFU/mL")+
  ggtitle("VPC of MOX PD Model with Acute Infection")  + 
  geom_vline(xintercept = c(treatmentday), linetype = 2)+
  #geom_line(data = obsSum, aes(x=TIMAST, y=medianDV, group=factor(ID), color = factor(ID)), linetype = 2)+
  #facet_wrap(~DOSER, nrow = 1)+
  theme_bw()+
  facet_wrap(~IDd, nrow=1)+
  ggtitle("P-A824")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "none"
  )

```



###LZD
```{r fig.height=2.5, fig.width=6}
working.directory<- '../data/vpc_folders/PD/LZD/'

observations_tablefile <- paste0(working.directory, 'vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, 'vpc_simulation.1.npctab.dta')

obs <- read_nm_table(observations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(DOSE != 0)
sim <- read_nm_table(simulations_tablefile) %>% 
  filter(MDV==0) %>% 
  mutate(LOG10DV = log10(exp(DV))) %>% 
  filter(DOSE != 0)

simSum <- sim %>%
  group_by(TIME, DOSE) %>% 
  summarise(medianDV = quantile(LOG10DV,prob=0.5,na.rm=T),
            upDV = quantile(LOG10DV,prob=0.95,na.rm=T),
            lowDV = quantile(LOG10DV,prob=0.05,na.rm=T))

obsSum <- obs %>% 
  group_by(TIME, DOSE) %>% 
  summarise(medianDV = median(LOG10DV))

#infectionday = 0
treatmentday = 6

LZD_PD_VPC <- ggplot(simSum, aes(TIME, medianDV))+
  geom_ribbon(aes(ymin = simSum$lowDV, ymax = simSum$upDV), alpha = 0.3, linetype = "blank", fill = "#FCC522")+
  geom_line(color = "#FCC522")+
  geom_point(data = obs, aes(TIME, LOG10DV), shape = 1)+
  scale_x_continuous(breaks = seq(0, 500, 7))+
  labs(x = "Time (days)", y = "log10 CFU")+
  #geom_vline(xintercept = c(treatmentday), linetype = 3)+
  geom_line(data = obsSum, aes(TIME, medianDV), linetype = 3)+
  facet_wrap(~DOSE, nrow = 1)+
  theme_bw()+
  ggtitle("LZD")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )

LZD_PD_VPC
```
###RPT
```{r fig.height=2.5, fig.width=6}
setwd("../data/vpc_folders/PD/RPT/vpc_dir07c/")

observations_tablefile <- "./m1/vpc_original.npctab.dta"
simulations_tablefile <- "./m1/vpc_simulation.1.npctab.dta"

obs <- read_nm_table(observations_tablefile) %>%
  filter(MDV==0) %>%
  mutate(LOG10DV = log10(exp(DV)))

sim <- read_nm_table(simulations_tablefile) %>%
  filter(MDV==0) %>%
  mutate(LOG10DV = log10(exp(DV)))

simSum <- sim %>%
  group_by(TIME,DOSE) %>%
  summarise(
    medianDV = quantile(DV, prob = 0.5, na.rm = T),
    upDV = quantile(DV, prob = 0.95, na.rm = T),
    lowDV = quantile(DV, prob = 0.05, na.rm = T) )


obsSum <- obs %>%
  group_by(TIME,DOSE) %>%
  summarise(medianDV = median(DV)) 

 treatmentday = 41
 
 unique(obs$TIME)

RPT_PD_VPC<- ggplot(simSum, aes(TIME, medianDV, group = DOSE)) +
  geom_ribbon(aes(ymin = simSum$lowDV, ymax = simSum$upDV), alpha = 0.3, linetype="blank", color = "#6B3E98" )+# size = 0.0001)) +
  scale_x_continuous(breaks = unique(obs$TIME),
                     labels = unique(obs$TIME) -41)+
  geom_line(color = "#6B3E98") +
  geom_point(data = obs, aes(TIME, DV), shape = 1) +
  #scale_x_continuous(breaks = seq(0, 500, 7)) +
  ylim(NA,25)+
  labs(x = "Time Since Treatment (days)", y = "log10 CFU") +
  geom_vline(xintercept = treatmentday, linetype = 2)+
  geom_line(data = obsSum, aes(TIME, medianDV), linetype = 2) +
  #facet_wrap(~DOSE, nrow = 1)+
  theme_bw() +
  ggtitle("RPT")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    legend.position = "none"
  )
RPT_PD_VPC
RPT_PD_VPC_facet <- RPT_PD_VPC + facet_wrap(~DOSE, nrow=1)
RPT_PD_VPC_facet
```
#ERROR!
##Final PD VPC combined
```{r}
grid.arrange(BDQ_PD_VPC,
             #DLM_PD_VPC,
             #RIF_PD_VPC,
             #INH_PD_VPC,
             #PZA_PD_VPC,
             #LZD_PD_VPC,
             #MXF_PD_VPC,
             #PA824_PD_VPC,
             RPT_PD_VPC
             )
```


#Figure 5: EBA simulation
###BDQ
```{r}
#load lit data
DR_BDQ <- read.csv("../data/EBA_simulations/BDQ/BDQ-DiaconRustojmee.csv",header=TRUE, skip=5)
names(DR_BDQ) <- c("TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(DR_BDQ)[8:22])
DR_BDQ$SD <- as.numeric(paste(DR_BDQ$SD))

DR_BDQ <- DR_BDQ %>%
  mutate(IDd   = factor(case_when(DOSE == 25 ~ "25 mg",
                          DOSE == 100 ~ "100 mg",
                          DOSE == 400 ~ "400 mg"), 
                          levels=c('25 mg','100 mg','400 mg')))

DR_BDQ$IDd[DR_BDQ$DOSE == 25] <-  "25 mg" 
DR_BDQ$IDd[DR_BDQ$DOSE == 100] <-  "100 mg" 
DR_BDQ$IDd[DR_BDQ$DOSE == 400] <-  "400 mg"
DR_BDQ$IDd = factor(DR_BDQ$IDd, levels=c('25 mg','100 mg','400 mg'))

Diacon <- DR_BDQ %>%
  filter(Study == "Diacon") %>%
  mutate(IDd   = factor(case_when(DOSE == 100 ~ "100 mg",
                          DOSE == 200 ~ "200 mg",
                          DOSE == 300 ~ "300 mg",
                          DOSE == 400 ~ "400 mg"), 
                          levels=c('100 mg','200 mg', '300 mg', '400 mg')))

```

```{r}
#load sims
setwd("../data/EBA_simulations/BDQ/")

#Rustomjee simulation
#Knet zero
simPKPD8 <- read_nm_table("tab15")
simPKPD8 <- simPKPD8 %>%
  filter(MDV==0) %>%
  mutate(IPRED = log10(exp(IPRED)),
         PRED  = log10(exp(IPRED))) %>%
  mutate(IDd   = factor(case_when(DOSE == 25 ~ "25 mg",
                          DOSE == 100 ~ "100 mg",
                          DOSE == 400 ~ "400 mg"), 
                          levels=c('25 mg','100 mg','400 mg'))) %>%  
  group_by(ID) %>%
  mutate(KILL = IPRED - IPRED[1])

#Diacon simulation
#Knet zero
simPKPD10 <- read_nm_table("tab16")
simPKPD10 <- simPKPD10 %>%
  filter(MDV==0) %>%
  mutate(IPRED = log10(exp(IPRED)),
         PRED  = log10(exp(IPRED))) %>%
  mutate(IDd   = factor(case_when(DOSE == 100 ~ "100 mg",
                          DOSE == 200 ~ "200 mg",
                          DOSE == 300 ~ "300 mg",
                          DOSE == 400 ~ "400 mg"), 
                          levels=c('100 mg','200 mg', '300 mg', '400 mg'))) %>%  
  group_by(ID) %>%
  mutate(KILL = IPRED - IPRED[1])
```

```{r fig.height=4, fig.width=9}
#plot knet/Rustomjee
BDQ_EBA_knet_R <- ggplot(data = simPKPD8, aes(x = TIME, y = IPRED))+
  facet_wrap("IDd")+
  stat_summary(geom="ribbon",fill = "#42B1AF", alpha = 0.3,
               fun.ymin = function(x) mean(x)-sd(x),
               fun.ymax = function(x) mean(x)+sd(x)) +
  stat_summary(geom="line", color = "#42B1AF",fun.y=mean)+
  geom_point(data=DR_BDQ[DR_BDQ$Study=="Rustomjee",],
             mapping = aes(x = TIME,y = log.CFU))+
  geom_errorbar(data=DR_BDQ[DR_BDQ$Study=="Rustomjee",],
                aes(x=TIME, y=log.CFU,ymin=log.CFU-SD, ymax=log.CFU+SD), width=.01)+
  labs(x = "Time (Days)", y = "log10CFU/mL") +
  scale_y_continuous(limits = c(4, 8))+
  ggtitle("BDQ, Rustomjee study")+
  scale_x_continuous(lim= c(0,7.1),
                     breaks = c(0,7),
                     minor_breaks = c(1,7))+
  theme_bw()+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

#plot knet/Diacon
BDQ_EBA_knet_D <- ggplot(data = simPKPD10, aes(x = TIME, y = IPRED))+
  xlim(0,14)+  
  facet_wrap("IDd", nrow=1)+
  stat_summary(geom="ribbon",fill = "#42B1AF", alpha = 0.3,
               fun.ymin = function(x) mean(x)-sd(x),
               fun.ymax = function(x) mean(x)+sd(x)) +
  stat_summary(geom="line", color = "#42B1AF",fun.y=mean)+
  geom_point(data = Diacon, aes(x=TIME, y=log.CFU, group=DOSE,))+
  geom_point(data = Diacon, aes(x=TIME, y=log.CFU, group=DOSE))+
  scale_y_continuous(limits = c(4, 8))+
  geom_errorbar(data = Diacon,
                aes(x=TIME, y=log.CFU,ymin=log.CFU-SD, ymax=log.CFU+SD), width=.01)+
  labs(x = "Time (Days)", y = "log10CFU/mL") +
  ggtitle("BDQ, Diacon study")+
  scale_x_continuous(lim= c(0,14),
                     breaks = c(0,2,7,14))+
  theme_bw()+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )



```

```{r fig.height=2.5, fig.width=6}
BDQ_EBA_knet_R
```


```{r fig.height=2.5, fig.width=8}
BDQ_EBA_knet_D
```


###INH Knet ACUTE
```{r fig.height=2.5, fig.width=14}
setwd("../data/eba_simulations/INH/")
simpkpd1 <- read_nm_table("sdtabHPKPD16a") # final acute
simpkpd10 <- read_nm_table("sdtabHPKPD16b") # final acute

simpkpd1 <- simpkpd1%>%
  filter(MDV==0)%>%
  filter(DOSE<=37.5)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)%>%
  mutate(DRUG="INH",
         DOSE1=paste(as.character(DOSE),"mg"),
         REGIMEN=paste(DRUG, DOSE1))

simpkpd10 <- simpkpd10%>%
  filter(MDV==0)%>%
  filter(DOSE>37.5)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)%>%
  mutate(DRUG="INH",
         DOSE1=paste(as.character(DOSE),"mg"),
         REGIMEN=paste(DRUG, DOSE1))

simpkpd_summary1<-rbind(simpkpd1,simpkpd10)%>%
  group_by(TIME,DOSE,DOSE1)%>%
  summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
            Q2=quantile(DV,prob=0.5,na.rm=T),
            Q3=quantile(DV,prob=0.975,na.rm=T))%>%
  mutate(model=" acute")

simpkpd11<-rbind(simpkpd1,simpkpd10)

simEBA1<-simpkpd11%>%
  filter(TIME==2)%>%
  group_by(DOSE)%>%
  mutate(EBA=(0-iKILL)/2)%>%
  select(DOSE,EBA)%>%
  distinct(DOSE,.keep_all=TRUE)%>%
  mutate(DRUG="INH",
         DOSE1=paste(as.character(DOSE),"mg"),
         REGIMEN=paste(DRUG, DOSE1))


# simpkpd2 <- simpkpd2%>%
#   filter(MDV==0)%>%
#   mutate(IPRED=log10(exp(IPRED)),
#          PRED=log10(exp(PRED)),
#          DV=log10(exp(DV)),
#          KILL=PRED-STARTCFULOG,
#          iKILL=IPRED-STARTCFULOG)%>%
#   mutate(DOSE1=paste(as.character(DOSE),"mg"))
# 
# simpkpd_summary2<-simpkpd2%>%
#   group_by(TIME,DOSE,DOSE1)%>%
#   summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
#             Q2=quantile(DV,prob=0.5,na.rm=T),
#             Q3=quantile(DV,prob=0.975,na.rm=T))%>%
#   mutate(model=" sub-acute")
# 
# simEBA2<-simpkpd2%>%
#   filter(TIME==2)%>%
#   group_by(DOSE)%>%
#   mutate(EBA=(0-iKILL)/2)%>%
#   select(DOSE,EBA)%>%
#   distinct(DOSE,.keep_all=TRUE)
# 
# simpkpd3 <- simpkpd3%>%
#   filter(MDV==0)%>%
#   mutate(IPRED=log10(exp(IPRED)),
#          PRED=log10(exp(PRED)),
#          DV=log10(exp(DV)),
#          KILL=PRED-STARTCFULOG,
#          iKILL=IPRED-STARTCFULOG)%>%
#   mutate(DOSE1=paste(as.character(DOSE),"mg"))
# 
# simpkpd_summary3<-simpkpd3%>%
#   group_by(TIME,DOSE,DOSE1)%>%
#   summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
#             Q2=quantile(DV,prob=0.5,na.rm=T),
#             Q3=quantile(DV,prob=0.975,na.rm=T))%>%
#   mutate(model="chronic")
# 
# simEBA3<-simpkpd3%>%
#   filter(TIME==2)%>%
#   group_by(DOSE)%>%
#   mutate(EBA=(0-iKILL)/2)%>%
#   select(DOSE,EBA)%>%
#   distinct(DOSE,.keep_all=TRUE)


simpkpd_summary<-(simpkpd_summary1)

donaldinh <- read.csv("./INH-Donald.csv",header=TRUE, skip=2)

donaldinh<-donaldinh%>%
  mutate(DOSE1=paste(as.character(DOSE),"mg"))

dose.labs <- c("9 mg", "18.75 mg", "37.5 mg", "75 mg", "150 mg", "300 mg", "600 mg")
names(dose.labs) <- c("9", "18.75", "37.5", "75", "150","300","600")

#time vs effect in human
ggplot(data = simpkpd_summary, aes(x = TIME, y = Q2))+
  geom_ribbon(aes(ymin = Q1, ymax = Q3),fill = "#2078B4", color = "#2078B4", alpha = 0.3,  linetype = "blank") +  
  geom_line( color = "#2078B4") +
  geom_point(data = donaldinh, aes(x = TIME, y = log10cfu), color = "black") +
  ylim(c(5,8))+
  scale_x_continuous(limits=c(0, 2), breaks=seq(0,14,2)) +
  theme_bw() +
  ggtitle("INH")+
  facet_wrap(~DOSE, nrow = 1, labeller = labeller(DOSE = dose.labs)) +
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())

```



###RIF Knet ACUTE
```{r fig.height=2.5, fig.width=10}
#setwd("../data/eba_simulations/r/")
simpkpd1 <- read_nm_table("../data/eba_simulations/RIF/simtabR11")%>%
   filter(ID<=5)%>%
  filter(MDV==0)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)
#  mutate(WTBSD=paste(as.character(WTBSD),"mg/kg"))

simpkpd_summary1<-simpkpd1%>%
  group_by(TIME,WTBSD)%>%
  summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
            Q2=quantile(DV,prob=0.5,na.rm=T),
            Q3=quantile(DV,prob=0.975,na.rm=T))%>%
  mutate(model=" acute")

simEBA1<-simpkpd1%>%
  filter(TIME==2)%>%
  group_by(WTBSD)%>%
  mutate(EBA=(0-iKILL)/2)%>%
  select(WTBSD,EBA)%>%
  distinct(WTBSD,.keep_all=TRUE)


simpkpd_summary<-rbind(simpkpd_summary1)



boeree_all <- read.csv("../data/eba_simulations/RIF/Boeree for R_alldose.csv", header=TRUE, skip =2)
names(boeree_all) <- c("TIME","KILL","BASELINE","log.CFU","WTBSD","Study","KillLB","KillUB","DOSE")

boeree_all <- boeree_all%>%
  mutate(DOSE=paste(as.character(DOSE),"mg"))

ggplot(data = simpkpd_summary, aes(x = TIME, y = Q2))+
  geom_ribbon(aes(ymin = Q1, ymax = Q3),fill = "#D12831", color = "#D12831", alpha = 0.3,  linetype = "blank") +  
  geom_line( color = "#D12831") +
  geom_point(data = boeree_all, aes(x = TIME, y = log.CFU), color = "black") +
  ylim(c(1,6))+
  scale_x_continuous(limits=c(0, 7), breaks=seq(0,14,7)) +
  theme_bw() +
  ggtitle("RIF")+
  facet_wrap(~WTBSD, nrow= 1)+#,   labeller = labeller(WTBSD = dose.labs)) +
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())

```

###MFX 
####knet ACUTE
```{r fig.height=2.5, fig.width=6}
setwd("../data/eba_simulations/MFX/")
mxf <- read.csv("MXF-2.csv",header=TRUE, skip=2)
names(mxf) <- c("TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(mxf)[8:13])
#mxfjohnson$IDd[mxfjohnson$DOSE==400] <-  "400 mg" 
mxf$IDd[mxf$Study=="Johnson"] <-  "Johnson 400 mg" 
mxf$IDd[mxf$Study=="Pletz"] <-  "Pletz 400 mg" 
mxf$IDd[mxf$Study=="Gosling"] <-  "Goslins 400 mg" 

simm1 <- read_nm_tables("sdtabMpkpd5e")

simm1$IPRED <- log10(exp(simm1$IPRED))
simm1$PRED <- log10(exp(simm1$PRED))
simm1$KILL<- (simm1$PRED-simm1$STARTCFULOG)
simm1$iKILL<- -(simm1$IPRED-simm1$STARTCFULOG)
simm1$IDd[simm1$ID==1]<- "Johnson 400 mg"
simm1$IDd[simm1$ID==2]<- "Pletz 400 mg"
simm1$IDd[simm1$ID==3]<- "Goslins 400 mg"

#simm1$IDd[simm1$DOSE==400] <-"400 mg"

ggplot(simm1, aes(x=TIME, y=IPRED))+
  #geom_point()+
  theme_bw()+
  stat_summary(geom="ribbon",fill = "#737478", fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha = 0.3) + 
  stat_summary(geom = "line", fun.y = mean, size=0.5, color="#737478")+
  geom_point(data = mxf, aes(x = TIME,y = log.CFU), color="black")+
  labs(x = "Time (Days)", y = expression(paste("log"["10"],"CFU/mL from Baseline")))+
  guides(colour = guide_legend(title = "infection model"))+
  #scale_x_continuous(limits = c(218,300))+
  ggtitle("MXF")+
  scale_x_continuous(lim= c(0,7),
                     breaks = c(0,2,5,7),
                     minor_breaks = c(seq(0,7,1)))+
  facet_grid(~IDd)+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

```

###DLM
####Knet
```{r fig.height=2.5, fig.width=8}
setwd("../data/eba_simulations/DLM/")

simpkpd1 <- read.nm.tables("sdtabDpkpd8c") 
simpkpd1 <- simpkpd1[simpkpd1$MDV==0,]
simpkpd1$IPRED <- log10(exp(simpkpd1$IPRED))
simpkpd1$PRED <- log10(exp(simpkpd1$PRED))
simpkpd1$KILL<- (simpkpd1$PRED-simpkpd1$STARTCFULOG)
simpkpd1$iKILL<- (simpkpd1$IPRED-simpkpd1$STARTCFULOG)
simpkpd1$IDd[simpkpd1$DOSE == 100] <-  "100 mg" 
simpkpd1$IDd[simpkpd1$DOSE == 200] <-  "200 mg"
simpkpd1$IDd[simpkpd1$DOSE == 300] <-  "300 mg"
simpkpd1$IDd[simpkpd1$DOSE == 400] <-  "400 mg"
simpkpd1$IDd = factor(simpkpd1$IDd, levels=c('100 mg','200 mg','300 mg','400 mg'))

DiaconDLM <- read.csv("DLM-Diacon.csv",header=TRUE, skip=2)
names(DiaconDLM) <- c("TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(DiaconDLM)[8:20])
DiaconDLM$IDd[DiaconDLM$DOSE == 100] <-  "100 mg" 
DiaconDLM$IDd[DiaconDLM$DOSE == 200] <-  "200 mg"
DiaconDLM$IDd[DiaconDLM$DOSE == 300] <-  "300 mg"
DiaconDLM$IDd[DiaconDLM$DOSE == 400] <-  "400 mg"
DiaconDLM$IDd = factor(DiaconDLM$IDd, levels=c('100 mg','200 mg','300 mg','400 mg'))

ggplot(data = simpkpd1, aes(x = TIME, y = IPRED))+
  theme_bw() +
  facet_grid(~IDd)+
  stat_summary(geom="ribbon",fill = "#F57F20", fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha = 0.3) + 
  stat_summary(geom="line", color = "#F57F20",fun.y=mean)+
  geom_point(data = DiaconDLM, aes(x = TIME,y = log.CFU))+
  scale_x_continuous(limits=c(0, 14), breaks=seq(0,14,7)) +
  #geom_errorbar(data=DiaconDLM, aes(x=TIME, y=KILL,ymin=KILLLB, ymax=KILLUB), width=.01)+
  #stat_summary(geom="line", data = litdata, fun.y = mean, aes(x = TIME,y = KILL))+
  labs(x = "Time (Days)", y = expression(paste("Change in log"["10"],"CFU/mL from Baseline"))) +
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )+
  ggtitle("DLM")

```


###PA824
####Knet acute
```{r fig.height=2.5, fig.width=16}
setwd("../data/eba_simulations/PA824/")
simpkpd6 <- read_nm_tables("sdtabPAPKPD9a")
simpkpd6 <- simpkpd6[simpkpd6$MDV==0,]

simpkpd6$IDd[simpkpd6$ID== 1] <- "200 mg-1"
simpkpd6$IDd[simpkpd6$ID== 5] <- "200 mg-2"
simpkpd6$IDd[simpkpd6$DOSE == 600] <- "600 mg"
simpkpd6$IDd[simpkpd6$DOSE == 1000] <- "1000 mg"
simpkpd6$IDd[simpkpd6$DOSE == 1200] <- "1200 mg"
simpkpd6$IDd[simpkpd6$DOSE==150] <- "150 mg"
simpkpd6$IDd[simpkpd6$DOSE == 100] <- "100 mg"
simpkpd6$IDd[simpkpd6$DOSE == 50] <- "50 mg"

simpkpd6$IPRED <- log10(exp(simpkpd6$IPRED))
simpkpd6$PRED <- log10(exp(simpkpd6$PRED))
simpkpd6$KILL<- (simpkpd6$PRED-simpkpd6$STARTCFULOG)
simpkpd6$iKILL<- -(simpkpd6$IPRED-simpkpd6$STARTCFULOG)



DiaconPA <- read.csv("PA-Diacon2.csv", skip = 2, header = T)
names(DiaconPA) <- c("ID","TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(DiaconPA)[9:22])

DiaconPA$DOSE <- as.numeric(DiaconPA$DOSE)

DiaconPA <- DiaconPA %>% arrange(DOSE)

DiaconPA$IDd[DiaconPA$ID== 1] <- "200 mg-1"
DiaconPA$IDd[DiaconPA$ID== 8] <- "200 mg-2"
DiaconPA$IDd[DiaconPA$DOSE == 600] <- "600 mg"
DiaconPA$IDd[DiaconPA$DOSE == 1000] <- "1000 mg"
DiaconPA$IDd[DiaconPA$DOSE == 1200] <- "1200 mg"
DiaconPA$IDd[DiaconPA$DOSE==150] <- "150 mg"
DiaconPA$IDd[DiaconPA$DOSE == 100] <- "100 mg"
DiaconPA$IDd[DiaconPA$DOSE == 50] <- "50 mg"

ggplot(data = simpkpd6, aes(x = TIME, y = IPRED))+
  theme_bw() +
  facet_wrap(~IDd, ncol=8)+
  stat_summary(geom="ribbon",fill = "#34A048", fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha = 0.3) + 
  stat_summary(geom="line", color = "#34A048",fun.y=mean)+
  geom_point(data = DiaconPA, aes(x = TIME,y = log.CFU))+
  scale_x_continuous(limits=c(0, 14), breaks=seq(0,14,7)) +
  #geom_errorbar(data=DiaconDLM, aes(x=TIME, y=KILL,ymin=KILLLB, ymax=KILLUB), width=.01)+
  #stat_summary(geom="line", data = litdata, fun.y = mean, aes(x = TIME,y = KILL))+
  labs(x = "Time (Days)", y = expression(paste("Change in log"["10"],"CFU/mL from Baseline"))) +
  ggtitle("PA824")+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )

```



###PZA KNET ACUTE
```{r fig.height=2.5, fig.width=2}
#setwd("~/Dropbox (Savic_Lab)/Nan/EBA Export Mar 2019/final sims/Pyrazinamide_Nan")
#simpkpd1 <- read_nm_table("simtabZ10") # final acute model 205a

#simpkpd1 <- read_nm_table("simtabZ11") # final sub-acute model 234a

#simpkpd1 <- read_nm_table("simtabZ12") # final chronic model 234a


simpkpd1 <- read_nm_table("../data/eba_simulations/PZA/simtabZ10a")%>% # final acute model 205a
  filter(ID>4)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)%>%
  mutate(DOSE1=paste(as.character(DOSE),"mg"))

simpkpd_summary1<-simpkpd1%>%
 # mutate(NID=ifelse(ID==1|ID==2,"Botha","Jindani"))%>%
  filter(MDV==0)%>%
  group_by(TIME)%>%
  summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
            Q2=quantile(DV,prob=0.5,na.rm=T),
            Q3=quantile(DV,prob=0.975,na.rm=T))%>%
  #filter(NID=="Botha")%>%
  mutate(model=" acute")

simEBA11<-simpkpd1%>%
  filter(TIME==2)%>%
  group_by(DOSE)%>%
  mutate(EBA=(0-iKILL)/2)%>%
  select(DOSE,EBA)%>%
  distinct(DOSE,.keep_all=TRUE)

simEBA1<-simpkpd1%>%
  filter(TIME==14)%>%
  group_by(DOSE)%>%
  mutate(EBA=(0-iKILL)/14)%>%
  select(DOSE,EBA)%>%
  distinct(DOSE,.keep_all=TRUE)



simpkpd_summary<-rbind(simpkpd_summary1) %>% mutate(DOSE = "2000 mg")


#time vs effect in human
 
 litdata <- read.csv("../data/eba_simulations/PZA/PZAData.csv", header=TRUE, skip =2)
 names(litdata) <- c("TIME","KILL","BASELINE","log.CFU","Study","Dose","EBA02", "EBA214","ID")
 
 litdata<-litdata%>%
   filter((ID>0&Study=="Jindani"))%>%
   rename(STARTCFULOG=BASELINE)%>%
   group_by(TIME)%>%
   mutate(CFU=mean(log.CFU)) %>% mutate(DOSE = "2000 mg")
   
ggplot(data = simpkpd_summary, aes(x = TIME, y = Q2))+
  geom_ribbon(aes(ymin = Q1, ymax = Q3),fill = "#FB9A99", color = "#FB9A99", alpha = 0.3,  linetype = "blank") +  
  geom_line( color = "#FB9A99") +
  geom_point(data = litdata, aes(x = TIME, y = CFU), color = "black") +
  ylim(c(4,8))+
  scale_x_continuous(limits=c(0, 14), breaks=seq(0,14,7)) +
  theme_bw() +
  ggtitle("PZA")+
  facet_wrap(~DOSE, nrow = 1) +
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank())

```




###LZD
```{r}
DietzeLZD <- read.csv("../data/eba_simulations/LZD/LZD-Dietze.csv", header = TRUE, skip = 2)
names(DietzeLZD) <- c("TIME", "KILL", "BASELINE", "log.CFU", "SD", "Study", "DOSE", names(DietzeLZD)[8:23])

DietzeLZD <- DietzeLZD %>%
  mutate(Drug = "LZD")
```


```{r}
simpkpd2 <- read_table2("../data/eba_simulations/LZD/LZD_final_sdtab", skip = 1)
simpkpd2$MDV <- as.numeric(simpkpd2$MDV)
simpkpd2$ID <- as.numeric(simpkpd2$ID)
simpkpd2$DOSE <- as.numeric(simpkpd2$DOSE)
simpkpd2$IPRED <- as.numeric(simpkpd2$IPRED)
simpkpd2$DV <- as.numeric(simpkpd2$DV)
simpkpd2$TIME <- as.numeric(simpkpd2$TIME)
simpkpd2$CC <- as.numeric(simpkpd2$CC)
simpkpd2 <- simpkpd2[simpkpd2$MDV=="0",]

simpkpd2$IPRED <- log10(exp(simpkpd2$IPRED))

```

```{r}
sumNanData2 <- simpkpd2 %>%
  group_by(TIME, ID, DOSE) %>%
  summarise(
    lo = quantile(IPRED, probs = 0.341, na.rm = T),
    up = quantile(IPRED, probs = 0.682, na.rm = T),
    med = quantile(IPRED, probs = 0.5, na.rm = T),
    cc = quantile(CC, probs = 0.5, na.rm = T),
    cclo = quantile(CC, probs = 0.025, na.rm = T),
    cchi = quantile(CC, probs = 0.975, na.rm = T),
  ) %>% 
  mutate(DOSE = ifelse(ID==1, "600 QD", "600 BID"))

sumNanData2 <- na.omit(sumNanData2)
```

```{r fig.height=2.5, fig.width=4}
ggplot(sumNanData2, aes(TIME, med)) +
  geom_ribbon(aes(ymin = lo, ymax = up), alpha = 0.3, size = 0.01, fill = "#FCC522") +
  geom_line(color = "#FCC522") +
  facet_wrap(~DOSE) +
  geom_point(data = DietzeLZD, aes(x = TIME, y = log.CFU)) +
  geom_linerange(data = DietzeLZD, aes(x = TIME, y = log.CFU, ymin = log.CFU-SD, ymax = log.CFU+SD)) +
  scale_x_continuous(breaks = seq(0, 1 * 7, 7)) +
  labs(x = "Time (hrs)", y = "Log10 CFU") +
  theme_bw() +
  ggtitle("LZD")+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
```



###RPT KNet Chronic
```{r}
#load lit data
sirgelrpt <- read.csv("../data/EBA_simulations/RPT/RPT-Sirgel.csv",
                      header=TRUE, skip=2) %>%
    mutate(IDd  = factor(case_when(Dose == 300 ~ "300 mg",
                          Dose == 600 ~ "600 mg",
                          Dose == 900 ~ "900 mg",
                          Dose == 1200 ~ "1200 mg"),
                          levels=c('300 mg','600 mg','900 mg','1200 mg')))

#load sim
setwd("../data/EBA_simulations/RPT/")

#knet zero / Sirgel
simPKPD1 <- read_nm_table("sdtabPPKPD08")

simPKPD1 <- simPKPD1 %>%
  filter(MDV==0) %>%
  mutate(IPRED = log10(exp(IPRED)),
         PRED  = log10(exp(IPRED))) %>%
  mutate(IDd   = factor(case_when(DOSE == 300 ~ "300 mg",
                          DOSE == 600 ~ "600 mg",
                          DOSE == 900 ~ "900 mg",
                          DOSE == 1200 ~ "1200 mg"),
                          levels=c('300 mg','600 mg','900 mg','1200 mg'))) %>%  
  group_by(ID) %>%
  mutate(KILL = IPRED - IPRED[1])
```

```{r fig.height=2.5, fig.width=8}
#plot knet zero / Sirgel

RPT_EBA_knet <- ggplot(data = simPKPD1, aes(x = TIME/24, y = IPRED))+
  facet_wrap("IDd", nrow = 1)+
  stat_summary(geom="ribbon",fill = "#6B3E98", alpha = 0.3,
               fun.ymin = function(x) mean(x)-sd(x),
               fun.ymax = function(x) mean(x)+sd(x)) +
  stat_summary(geom="line", color = "#6B3E98",fun.y=mean)+
  geom_point(sirgelrpt, mapping = aes(x = TIME, y = log10cfu))+
  labs(x = "Time (Days)", y = "log10CFU/mL") +
  scale_y_continuous(limits = c(4, 8))+
  ggtitle("RPT")+
  theme_bw()+
  theme(
      strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )


RPT_EBA_knet
```


#Figure 6: Comparison of all drug EBA predictions
```{r}
EBA_all <- read.csv("../data/eba_simulations/EBA_all/Composite_Data_change_CFUV2.csv")
EBA_all <- na.omit(EBA_all)
```

```{r}
drug_colors <- c(
  "BDQ" = "#42B1AF",  #teal
  "DLM" =  "#F57F20", #orange
  "INH" = "#2078B4", #blue
  "LZD" = "#FCC522",#yellow
  "MXF" = "#737478",#grey
  "PA-824" = "#34A048", #green
  "PZA" = "#FB9A99", #pink
  "RIF" = "#D12831",#red
  "RPT" =  "#6B3E98" # purple
  )

```

```{r fig.height=9, fig.width=9}
EBA_ns_plot_knet <- ggplot(subset(EBA_all, model == "knet"), aes(change_cfu_lit, change_cfu_sim, color = drug))+
  #geom_errorbar(aes(y = 0-EBAsim, ymin=0-EBAsim95LB, ymax=0-EBAsim95UB), color = "#42B1AF", width=0.001, size = 5, alpha = 0.3)+
  #geom_boxplot(aes(middle = change_cfu_sim, upper = change_cfu_upper_sim, lower = change_cfu_lower_sim, ymin = change_cfu_upper_sim, ymax = change_cfu_lower_sim), fill = "#c0e5e4", color = "NA", stat = "identity", position = position_dodge2(preserve = "single", width = 0.8))+
  #geom_point(aes(y = change_cfu_sim),  size = 2, shape = 21, stroke = 1, fill = "white", color = "#42b1af")+
  geom_point()+
  #labs(y = "change_cf", x = "Dose (mg)")+
  #geom_errorbarh(aes(x = change_cfu_lit, xmin=change_cfu_lit-sd_lit, xmax=change_cfu_lit+sd_lit))+
  #geom_errorbar(aes(y = change_cfu_sim, ymin = change_cfu_lower_sim, ymax = change_cfu_upper_sim))+
  geom_text(aes(label=paste(drug, " (", dose_mg, sep = "", " mg)")), size = 2.8, hjust = -0.05, vjust = -1)+
  #coord_flip()+
  geom_abline(intercept = 0, linetype = 2)+
 geom_abline(intercept = 0.5, linetype = 3)+
  geom_abline(intercept = -0.5, linetype = 3)+
  #facet_wrap(~drug, scales = "free")+
  scale_color_manual(values = drug_colors)+
  scale_fill_manual(values = drug_colors)+
  theme_bw()+
  theme(strip.background = element_rect(fill = 'white', colour = 'black'),
        legend.position = "top",
         panel.grid.major = element_blank(), panel.grid.minor = element_blank())

EBA_ns_plot_knet

```


#Figure 7 Scaled PK
###BDQ
```{r}
setwd("../data/PK_simulations/BDQ/")
SIM_1 <- read.csv("BDQ_human_pk_model_v_scaled.csv")
SIM_1 <- SIM_1 %>%
  mutate(IDd   = factor(case_when(DOSE == 25 ~ "25 mg",
                          DOSE == 100 ~ "100 mg",
                          DOSE == 400 ~ "400 mg"), 
                          levels=c('25 mg','100 mg','400 mg')))

ggplot(data = SIM_1, aes(x=TIME, y = CP, color=as.factor(ORIGIN),fill=as.factor(ORIGIN)))+
 stat_summary(geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.5,lwd=0.0001) +
 stat_summary(geom="line", fun.y=mean)+
 theme_bw()+
 facet_wrap(~IDd, nrow=1)+
 labs(x = "Time (h)", y = "Concentration (mg/L)")+
 theme(strip.text = element_text(size = 12, colour = "Black"),
       axis.title = element_text(size=14),
       axis.text = element_text(size = 12, color="Black"),
       legend.text = element_text(size=12),
       legend.title = element_text()) +
    scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  #scale_y_log10()+
  #xlim(0,1)+
 ggtitle("BDQ PK Simulation - Shaded area (95% PI)")
```

###DLM
```{r}
setwd("../data/PK_simulations/DLM/")
simpkpd2 <- read.nm.tables("sdtabDpkpd8b") 
simpkpd2 <- simpkpd2[simpkpd2$MDV==0,]

simpkpd2$IDd[simpkpd2$DOSE == 100] <-  "100 mg" 
simpkpd2$IDd[simpkpd2$DOSE == 200] <-  "200 mg"
simpkpd2$IDd[simpkpd2$DOSE == 300] <-  "300 mg"
simpkpd2$IDd[simpkpd2$DOSE == 400] <-  "400 mg"
simpkpd2$IDd = factor(simpkpd2$IDd, levels=c('100 mg','200 mg','300 mg','400 mg'))

simpkpd3 <- read.nm.tables("sdtabDpkpd10") 
simpkpd3 <- simpkpd3[simpkpd3$MDV==0,]
simpkpd3$IDd[simpkpd3$DOSE == 100] <-  "100 mg" 
simpkpd3$IDd[simpkpd3$DOSE == 200] <-  "200 mg"
simpkpd3$IDd[simpkpd3$DOSE == 300] <-  "300 mg"
simpkpd3$IDd[simpkpd3$DOSE == 400] <-  "400 mg"
simpkpd3$IDd = factor(simpkpd3$IDd, levels=c('100 mg','200 mg','300 mg','400 mg'))


simpkpd3$model <- "DLM scaled"
simpkpd2$model <- "DLM human"

SIM3 <- rbind(simpkpd2, simpkpd3)
SIM3 <- filter(SIM3, TIME>0)
SIM3$model <- as.factor(SIM3$model)
ggplot(data = SIM3, aes(x=TIME*24, y = CP, color=model,fill=model))+
  stat_summary(geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  stat_summary(geom="line", fun.y=mean, lwd=0.8)+
  theme_bw()+
  facet_wrap(~IDd, nrow=2)+
  xlim(0,48)+
  labs(x = "Time (d)", y = "Concentration (mg/L)")+
    scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  theme(strip.background = element_rect(fill = NA, color = "black"), legend.position = "top")
  theme(strip.text = element_text(size = 12, colour = "Black"),
        axis.title = element_text(size=14),
        axis.text = element_text(size = 12, color="black"),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14),
        legend.position = "top") 
 # ggtitle("DLM PK Simulation - Shaded area (95% PI)") 

```

###INH
```{r}

#setwd("../data/PK_simulations/INH")
HumanPKmodel<-read_nm_table("../data/PK_simulations/INH/sdtabHPKPD19")

HumanPKmodel<-HumanPKmodel%>%
  #filter(ID<=5)%>%
  filter(EVID==0)%>%
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(CP,prob=0.025,na.rm=T),
            Q2=quantile(CP,prob=0.5,na.rm=T),
            Q3=quantile(CP,prob=0.975,na.rm=T))%>%
  mutate(model="human")

MousePKmodel<-read_nm_table("../data/PK_simulations/INH/nan16")

MousePKmodel<-MousePKmodel%>%
 # filter(ID<=5)%>%
  filter(EVID==0)%>%
  group_by(DOSE,TIME)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="mice")

ggplot() +
  xlab("Time (Hours)") +
  ylab("INH Conc (ug/mL)") +
  geom_ribbon(data=HumanPKmodel, aes(x=TIMEH,ymin=Q1,ymax=Q3,fill="human"),alpha=0.6,lwd=0.8) +
  geom_line(data=HumanPKmodel, aes(x=TIMEH,y=Q2,group=DOSE,color="human"),size=1) +
  
  geom_ribbon(data=MousePKmodel, aes(x=TIME,ymin=Q1,ymax=Q3,fill="mice"),alpha=0.6,lwd=0.8) +
  geom_line(data=MousePKmodel, aes(x=TIME,y=Q2,group=DOSE,color="mice"),size=1) +
  
  guides(colour = guide_legend(title = "Model"), fill =guide_legend(title = "Model"))  +
  #scale_y_continuous(limits=c(0,150),breaks=seq(0,160,20)) +
  scale_x_continuous(limits=c(0,48),breaks=seq(0,48,4)) +
  #geom_hline(yintercept=(10), linetype=2, color="red", size=1)+
  theme_bw(base_size=10)+
  facet_wrap(~DOSE, scales = "free_y") +
    scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  theme(strip.background = element_rect(fill = NA, color = "black"), legend.position = "top")
  theme(legend.title = element_text(size = 16),legend.text = element_text(size = 14)) +
  theme(axis.title = element_text(size = 16),strip.text = element_text(size=12),axis.text = element_text(size=12)) 
  theme(legend.position="none")
  


```

###LZD
```{r}
lzd_scaled_data <- read.csv("../data/PK_simulations/LZD/scaled_LZD_table.csv")

ggplot(lzd_scaled_data, aes(time*24, med, color = origin, fill = origin)) +
  geom_ribbon(aes(ymin = lo, ymax = up), alpha = 0.4, size = 0.01) +
  geom_line() +
  facet_wrap(~DOSE) +
  scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  scale_x_continuous(breaks = seq(0, 24 * 7, 6), limits = c(0,24)) +
  labs(x = "Time (days)", y = "Conc mg/L") +
  theme_bw() +
  theme(strip.background = element_rect(fill = NA, color = "black"), legend.position = "top")
```

###MFX
```{r}
setwd("../data/PK_simulations/MFX/")
simmpk1 <- read_nm_tables("sdtabMpkpd10")
simmpk1 <- simmpk1[simmpk1$MDV==0,]
simmpk1$CP<-simmpk1$CP*50

simmpk2 <- read_nm_tables("sdtabMpkpd5e1")
simmpk2<- simmpk2[simmpk1$MDV==0,]


simmpk1$model <- "mice"
simmpk2$model <- "human"

SIM2 <- rbind(simmpk1, simmpk2)
SIM2$model<- as.factor(SIM2$model)
SIM2 <- filter(SIM2, TIME>0)

ggplot(data = SIM2, aes(x=TIME*24, y = CP, color=model,fill=model))+
  stat_summary(geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.5, color=NA) + 
  stat_summary(geom="line", fun.y=mean, lwd=0.8)+
  theme_bw()+
    labs(x = "Time (d)", y = "Concentration (mg/L)")+
  xlim(0,48)+
  scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  theme(strip.background = element_rect(fill = NA, color = "black"), legend.position = "top")
  theme(strip.text = element_text(size = 12, colour = "Black"),
        axis.title = element_text(size=14),
        axis.text = element_text(size = 12, color="black"),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14), legend.position = "top") 
  #ggtitle("MFX PK Simulation - Shaded area (95% PI)") 

```

###PA824
```{r}
setwd("../data/PK_simulations/PA824/")
simpk1 <- read_nm_tables("sdtabPAPKPD13")
simpk1<- simpk1[simpk1$MDV==0,]
#simpk1<-filter(simpk1, TIMEH<=48)

simpk1$IDd[simpk1$ID== 1] <- "200 mg-1"
simpk1$IDd[simpk1$ID== 5] <- "200 mg-2"
simpk1$IDd[simpk1$ID== 9] <- "200 mg-1"
simpk1$IDd[simpk1$ID== 13] <- "200 mg-2"
simpk1$IDd[simpk1$ID== 17] <- "200 mg-1"
simpk1$IDd[simpk1$ID== 21] <- "200 mg-2"
#simpk1$IDd[simpk1$IDd== "NA"] <- "200 mg-1"
simpk1$IDd[simpk1$DOSE == 600] <- "600 mg"
simpk1$IDd[simpk1$DOSE == 1000] <- "1000 mg"
simpk1$IDd[simpk1$DOSE == 1200] <- "1200 mg"
simpk1$IDd[simpk1$DOSE==150] <- "150 mg"
simpk1$IDd[simpk1$DOSE == 100] <- "100 mg"
simpk1$IDd[simpk1$DOSE == 50] <- "50 mg"

simpk0 <- read_nm_tables("sdtabPAPKPD9a")
simpk0<- simpk0[simpk0$MDV==0,]
#simpk0<-filter(simpk0, TIMEH<=48)

simpk0$IDd[simpk0$ID== 1] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 5] <- "200 mg-2"
simpk0$IDd[simpk0$ID== 9] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 13] <- "200 mg-2"
simpk0$IDd[simpk0$ID== 17] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 21] <- "200 mg-2"
#simpk0$IDd[simpk0$IDd== "NA"] <- "200 mg-1"
simpk0$IDd[simpk0$DOSE == 600] <- "600 mg"
simpk0$IDd[simpk0$DOSE == 1000] <- "1000 mg"
simpk0$IDd[simpk0$DOSE == 1200] <- "1200 mg"
simpk0$IDd[simpk0$DOSE==150] <- "150 mg"
simpk0$IDd[simpk0$DOSE == 100] <- "100 mg"
simpk0$IDd[simpk0$DOSE == 50] <- "50 mg"
simpk1$model <- "mice"
simpk0$model <- "human"


SIM1 <- rbind(simpk0, simpk1)
SIM1 <- filter(SIM1, TIME >0)
SIM1$model<- as.factor(SIM1$model)

ggplot(data = SIM1, aes(x=TIMEH, y = CP, color=model,fill=model)) +
  stat_summary(geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.5, color=NA, lwd=0.000008) + 
  stat_summary(geom="line", fun.y=mean)+
  theme_bw()+
  facet_wrap(~IDd, nrow=2)+
    scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  xlim(0,48)+
  labs(x = "Time (d)", y = "Concentration (mg/L)")+
  theme(strip.text = element_text(size = 12, colour = "Black"),
        axis.title = element_text(size=14),
        axis.text = element_text(size = 12, color="black"),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14), legend.position = "top") 
  #ggtitle("PA-824 PK Simulation - Shaded area (95% PI)") 

```

###PZA
```{r}
#setwd("../data/PK_simulations/PZA")
HumanPKmodel<-read_nm_table("../data/PK_simulations/PZA/simtabZ7")

HumanPKmodel<-HumanPKmodel%>%
  filter(ID>=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(CP,prob=0.025,na.rm=T),
            Q2=quantile(CP,prob=0.5,na.rm=T),
            Q3=quantile(CP,prob=0.975,na.rm=T))%>%
  mutate(model="human")

MousePKmodel<-read_nm_table("../data/PK_simulations/PZA/nan22")

MousePKmodel<-MousePKmodel%>%
  filter(ID>=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIME)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="mice")

ggplot() +
  xlab("Time (hours)") +
  ylab("PZA Conc (ug/mL)") +
  geom_ribbon(data=HumanPKmodel, aes(x=TIMEH,ymin=Q1,ymax=Q3,fill="human"),alpha=0.6,lwd=0.8) +
  geom_line(data=HumanPKmodel, aes(x=TIMEH,y=Q2,group=DOSE,color="human"),size=1) +
  
  geom_ribbon(data=MousePKmodel, aes(x=TIME,ymin=Q1,ymax=Q3,fill="mice"),alpha=0.6,lwd=0.8) +
  geom_line(data=MousePKmodel, aes(x=TIME,y=Q2,group=DOSE,color="mice"),size=1) +
    scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  guides(colour = guide_legend(title = "Model"), fill =guide_legend(title = "Model"))  +
  #scale_y_continuous(limits=c(0,150),breaks=seq(0,160,20)) +
  scale_x_continuous(limits=c(0,48),breaks=seq(0,48,4)) +
  #geom_hline(yintercept=(10), linetype=2, color="red", size=1)+
  theme_bw(base_size=10)+
  facet_wrap(~DOSE, scales = "free_y") +
  theme(legend.title = element_text(size = 16),legend.text = element_text(size = 14)) +
  theme(axis.title = element_text(size = 16),strip.text = element_text(size=12),axis.text = element_text(size=12)) 
  theme(legend.position="none")
  
```

###RIF
```{r}
#setwd("../data/PK_simulations/RIF")
HumanPKmodel<-read_nm_table("../data/PK_simulations/RIF/simtabR1")

HumanPKmodel<-HumanPKmodel%>%
  filter(ID<=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="human")

MousePKmodel<-read_nm_table("../data/PK_simulations/RIF/nan23")

MousePKmodel<-MousePKmodel%>%
  filter(ID<=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIME)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="mice")

ggplot() +
  xlab("Time (Hours)") +
  ylab("INH Conc (ug/mL)") +
  geom_ribbon(data=HumanPKmodel, aes(x=TIMEH,ymin=Q1,ymax=Q3,fill="human"),alpha=0.6,lwd=0.8) +
  geom_line(data=HumanPKmodel, aes(x=TIMEH,y=Q2,group=DOSE,color="human"),size=1) +
  
  geom_ribbon(data=MousePKmodel, aes(x=TIME,ymin=Q1,ymax=Q3,fill="mice"),alpha=0.6,lwd=0.8) +
  geom_line(data=MousePKmodel, aes(x=TIME,y=Q2,group=DOSE,color="mice"),size=1) +
    scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
  guides(colour = guide_legend(title = "Model"), fill =guide_legend(title = "Model"))  +
  #scale_y_continuous(limits=c(0,150),breaks=seq(0,160,20)) +
  scale_x_continuous(limits=c(0,48),breaks=seq(0,48,4)) +
  #geom_hline(yintercept=(10), linetype=2, color="red", size=1)+
  theme_bw(base_size=10)+
  facet_wrap(~DOSE, scales = "free_y") +
  theme(legend.title = element_text(size = 16),legend.text = element_text(size = 14)) +
  theme(axis.title = element_text(size = 16),strip.text = element_text(size=12),axis.text = element_text(size=12)) 
  theme(legend.position="none")
  

```

###RPT

```{r}
setwd("../data/PK_simulations/RPT/")
simPKPD2<- read_nm_table("sdtabPPKPD06")
names(simPKPD2)
unique(simPKPD2$DOSE)
simPKPD2 <- simPKPD2 %>%
 filter(MDV==0) %>%
 mutate(IPRED = log10(exp(IPRED)),
        PRED  = log10(exp(IPRED))) %>%
 mutate(Dose   = factor(case_when(DOSE == 300 ~ "300 mg",
                                  DOSE == 600 ~ "600 mg",
                                  DOSE == 900 ~ "900 mg",
                                  DOSE == 1200 ~ "1200 mg"),
                        levels=c("300 mg","600 mg","900 mg","1200 mg"))) %>%
 group_by(ID)
simPKPD3<- read_nm_table("sdtabPPKPD02b")
names(simPKPD3)
unique(simPKPD3$DOSE)
simPKPD3 <- simPKPD3 %>%
 filter(MDV==0) %>%
 mutate(IPRED = log10(exp(IPRED)),
        PRED  = log10(exp(IPRED))) %>%
 mutate(Dose   = factor(case_when(DOSE == 300 ~ "300 mg",
                                  DOSE == 600 ~ "600 mg",
                                  DOSE == 900 ~ "900 mg",
                                  DOSE == 1200 ~ "1200 mg"),
                        levels=c("300 mg","600 mg","900 mg","1200 mg"))) %>%
 group_by(ID)
simPKPD2$model <-"RPT scaled"
simPKPD3$model <-"RPT human"
SIM4 <- rbind(simPKPD2, simPKPD3)
ggplot(data = SIM4, aes(x=TIME, y = CP, color=as.factor(model),fill=as.factor(model)))+
 stat_summary(geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.5, lwd = 0.0001) +
 stat_summary(geom="line", fun.y=mean)+
    scale_color_manual(values = EBA_team) +
  scale_fill_manual(values = EBA_team) +
 theme_bw()+
 facet_wrap(~Dose, nrow=2)+
 labs(x = "Time (h)", y = "Concentration (mg/L)")+
 theme(strip.text = element_text(size = 12, colour = "Black"),
       axis.title = element_text(size=14),
       axis.text = element_text(size = 12, color="Black"),
       legend.text = element_text(size=12),
       legend.title = element_text(size=14)) +
  #geom_hline(yintercept = 0.838)+
  #scale_y_log10()+
 ggtitle("RPT PK Simulation - Shaded area (95% PI)")
```

##Figure 7 scaled - simplified
###BDQ
```{r}
scaled <- c(
    "#D12831",
  "#42B1AF"

)
```

```{r fig.height=5, fig.width=5}
setwd("../data/PK_simulations/BDQ/")
SIM_1 <- read.csv("BDQ_human_pk_model_v_scaled.csv")
SIM_1 <- SIM_1 %>%
  mutate(IDd   = factor(case_when(DOSE == 25 ~ "25 mg",
                          DOSE == 100 ~ "100 mg",
                          DOSE == 400 ~ "400 mg"), 
                          levels=c('25 mg','100 mg','400 mg'))) %>% 
  filter(DOSE == 400)


bdq_scaled_pk <- ggplot(SIM_1, aes(x=TIME*24, y = CP, group=as.factor(ORIGIN), linetype = ORIGIN))+
  stat_summary(data = subset(SIM_1, ORIGIN == "BDQ human"),geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.7,fill = "#42B1AF",  lwd=0.0001) +
   stat_summary(data = subset(SIM_1, ORIGIN == "BDQ scaled"),geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.3,lwd=0.0001, fill = "#42B1AF") +
 stat_summary(geom="line", fun.y=median, color = "#42B1AF")+
 facet_wrap(~IDd, nrow=1)+
  ggtitle("BDQ")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none") 

bdq_scaled_pk
```

###DLM
```{r}
setwd("../data/PK_simulations/DLM/")
simpkpd2 <- read.nm.tables("sdtabDpkpd8b") 
simpkpd2 <- simpkpd2[simpkpd2$MDV==0,]

simpkpd2$IDd[simpkpd2$DOSE == 100] <-  "100 mg" 
simpkpd2$IDd[simpkpd2$DOSE == 200] <-  "200 mg"
simpkpd2$IDd[simpkpd2$DOSE == 300] <-  "300 mg"
simpkpd2$IDd[simpkpd2$DOSE == 400] <-  "400 mg"
simpkpd2$IDd = factor(simpkpd2$IDd, levels=c('100 mg','200 mg','300 mg','400 mg'))

simpkpd3 <- read.nm.tables("sdtabDpkpd10") 
simpkpd3 <- simpkpd3[simpkpd3$MDV==0,]
simpkpd3$IDd[simpkpd3$DOSE == 100] <-  "100 mg" 
simpkpd3$IDd[simpkpd3$DOSE == 200] <-  "200 mg"
simpkpd3$IDd[simpkpd3$DOSE == 300] <-  "300 mg"
simpkpd3$IDd[simpkpd3$DOSE == 400] <-  "400 mg"
simpkpd3$IDd = factor(simpkpd3$IDd, levels=c('100 mg','200 mg','300 mg','400 mg'))


simpkpd3$model <- "DLM scaled"
simpkpd2$model <- "DLM human"

SIM3 <- rbind(simpkpd2, simpkpd3)
SIM3 <- filter(SIM3, TIME>0, DOSE==100)
SIM3$model <- as.factor(SIM3$model)

dlm_scaled_pk <- ggplot(SIM3, aes(x=TIME*24, y = CP, group=model,linetype=model))+
  stat_summary(data = subset(SIM3, model == "DLM human"), geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.7, color=NA, fill = "#F57F20") + 
    stat_summary(data = subset(SIM3, model == "DLM scaled"), geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.3, color=NA, fill = "#F57F20") + 
  stat_summary(geom="line", fun.y=median, color ="#F57F20")+
  theme_bw()+
  facet_wrap(~IDd, nrow=2)+
  ggtitle("DLM")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none") 
 # ggtitle("DLM PK Simulation - Shaded area (95% PI)") 

dlm_scaled_pk 
```

###INH
```{r}

#setwd("../data/PK_simulations/INH")
HumanPKmodel<-read_nm_table("../data/PK_simulations/INH/sdtabHPKPD19")

HumanPKmodel<-HumanPKmodel%>%
  #filter(ID<=5)%>%
  filter(EVID==0)%>%
  filter(DOSE==300) %>% 
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(CP,prob=0.025,na.rm=T),
            Q2=quantile(CP,prob=0.5,na.rm=T),
            Q3=quantile(CP,prob=0.975,na.rm=T))%>%
  mutate(model="human")

MousePKmodel<-read_nm_table("../data/PK_simulations/INH/nan16")

MousePKmodel<-MousePKmodel%>%
 # filter(ID<=5)%>%
  filter(DOSE==300) %>% 
  filter(EVID==0)%>%
  group_by(DOSE,TIME)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="mice", TIMEH=TIME)

inh_scaled_data <- bind_rows(HumanPKmodel, MousePKmodel)
inh_scaled_data$model <- as.factor(inh_scaled_data$model)

inh_scaled_pk <- ggplot(inh_scaled_data, aes(x=TIMEH, y = Q2, group = model, linetype = model))+
  geom_ribbon(data = subset(inh_scaled_data, model=="mice"), aes(ymin = Q1, ymax = Q3), alpha = 0.7, size = 0.01, fill = "#2078B4") +
  geom_ribbon(data = subset(inh_scaled_data, model=="human"), aes(ymin = Q1, ymax = Q3), alpha = 0.7, size = 0.01, fill = "#2078B4") +
  geom_line(color = "#2078B4") +
  theme_bw()+
  facet_wrap(~DOSE, nrow=2)+
  ggtitle("INH")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none") 
  
inh_scaled_pk

```

###LZD
```{r}
lzd_scaled_data <- read.csv("../data/PK_simulations/LZD/scaled_LZD_table.csv")

lzd_scaled_data <- subset(lzd_scaled_data, DOSE == "600 QD")

lzd_scaled_pk <- ggplot(lzd_scaled_data, aes(time*24, med, group = origin, linetype = origin)) +
  geom_ribbon(data = subset(lzd_scaled_data, origin == "LZD human"), aes(ymin = lo, ymax = up), alpha = 0.5, size = 0.01, fill = "#FCC522") +
  geom_ribbon(data = subset(lzd_scaled_data, origin == "LZD scaled"), aes(ymin = lo, ymax = up), alpha = 0.2, size = 0.0, fill = "#FCC522") +
  geom_line() +
  facet_wrap(~DOSE) +
  ggtitle("LZD")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none")

lzd_scaled_pk
```

###MFX
```{r}
setwd("../data/PK_simulations/MFX/")
simmpk1 <- read_nm_tables("sdtabMpkpd10")
simmpk1 <- simmpk1[simmpk1$MDV==0,]
simmpk1$CP<-simmpk1$CP*50

simmpk2 <- read_nm_tables("sdtabMpkpd5e1")
simmpk2<- simmpk2[simmpk1$MDV==0,]


simmpk1$model <- "mice"
simmpk2$model <- "human"

SIM2 <- rbind(simmpk1, simmpk2)
SIM2$model<- as.factor(SIM2$model)
SIM2 <- filter(SIM2, TIME>0)

mfx_scaled_pk <- ggplot(data = SIM2, aes(x=TIME*24, y = CP, color=model,fill=model))+
  stat_summary(geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.4, color=NA) + 
  facet_wrap(~DOSE) +
  stat_summary(geom="line", fun.y=mean)+
  scale_color_manual(values = scaled) +
  scale_fill_manual(values = scaled) +
  ggtitle("MFX")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none")

mfx_scaled_pk
```

###PA824
```{r}
setwd("../data/PK_simulations/PA824/")
simpk1 <- read_nm_tables("sdtabPAPKPD13")
simpk1<- simpk1[simpk1$MDV==0,]
#simpk1<-filter(simpk1, TIMEH<=48)

simpk1$IDd[simpk1$ID== 1] <- "200 mg-1"
simpk1$IDd[simpk1$ID== 5] <- "200 mg-2"
simpk1$IDd[simpk1$ID== 9] <- "200 mg-1"
simpk1$IDd[simpk1$ID== 13] <- "200 mg-2"
simpk1$IDd[simpk1$ID== 17] <- "200 mg-1"
simpk1$IDd[simpk1$ID== 21] <- "200 mg-2"
#simpk1$IDd[simpk1$IDd== "NA"] <- "200 mg-1"
simpk1$IDd[simpk1$DOSE == 600] <- "600 mg"
simpk1$IDd[simpk1$DOSE == 1000] <- "1000 mg"
simpk1$IDd[simpk1$DOSE == 1200] <- "1200 mg"
simpk1$IDd[simpk1$DOSE==150] <- "150 mg"
simpk1$IDd[simpk1$DOSE == 100] <- "100 mg"
simpk1$IDd[simpk1$DOSE == 50] <- "50 mg"

simpk0 <- read_nm_tables("sdtabPAPKPD9a")
simpk0<- simpk0[simpk0$MDV==0,]
#simpk0<-filter(simpk0, TIMEH<=48)

simpk0$IDd[simpk0$ID== 1] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 5] <- "200 mg-2"
simpk0$IDd[simpk0$ID== 9] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 13] <- "200 mg-2"
simpk0$IDd[simpk0$ID== 17] <- "200 mg-1"
simpk0$IDd[simpk0$ID== 21] <- "200 mg-2"
#simpk0$IDd[simpk0$IDd== "NA"] <- "200 mg-1"
simpk0$IDd[simpk0$DOSE == 600] <- "600 mg"
simpk0$IDd[simpk0$DOSE == 1000] <- "1000 mg"
simpk0$IDd[simpk0$DOSE == 1200] <- "1200 mg"
simpk0$IDd[simpk0$DOSE==150] <- "150 mg"
simpk0$IDd[simpk0$DOSE == 100] <- "100 mg"
simpk0$IDd[simpk0$DOSE == 50] <- "50 mg"
simpk1$model <- "mice"
simpk0$model <- "human"


SIM1 <- rbind(simpk0, simpk1)
SIM1 <- filter(SIM1, TIME >0)
SIM1$model<- as.factor(SIM1$model)

pa824_scaled_pk <- ggplot(data = subset(SIM1, DOSE ==200), aes(x=TIMEH, y = CP, color=model,fill=model)) +
  stat_summary(geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.5, color=NA, lwd=0.000008) + 
  stat_summary(geom="line", fun.y=mean)+
  facet_wrap(~DOSE)+
  scale_color_manual(values = scaled) +
  scale_fill_manual(values = scaled) +
  ggtitle("PA824")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none")
pa824_scaled_pk
```

###PZA
```{r}
#setwd("../data/PK_simulations/PZA")
HumanPKmodel<-read_nm_table("../data/PK_simulations/PZA/simtabZ7")

HumanPKmodel<-HumanPKmodel%>%
  filter(ID>=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(CP,prob=0.025,na.rm=T),
            Q2=quantile(CP,prob=0.5,na.rm=T),
            Q3=quantile(CP,prob=0.975,na.rm=T))%>%
  mutate(model="human")

MousePKmodel<-read_nm_table("../data/PK_simulations/PZA/nan22")

MousePKmodel<-MousePKmodel%>%
  filter(ID>=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIME)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="mice", TIMEH=TIME)

pza_scaled_data <- bind_rows(HumanPKmodel, MousePKmodel)

pza_scaled_pk <- ggplot(data = pza_scaled_data, aes(x=TIMEH, y = Q2, color=model,fill=model))+
  geom_ribbon(aes(ymin = Q1, ymax = Q3), alpha = 0.4, size = 0.01) +
  geom_line() +
  theme_bw()+
  facet_wrap(~DOSE, nrow=2)+
  scale_color_manual(values = scaled) +
  scale_fill_manual(values = scaled) +
  ggtitle("PZA")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none") 

  pza_scaled_pk
```

###RIF
```{r}
#setwd("../data/PK_simulations/RIF")
HumanPKmodel<-read_nm_table("../data/PK_simulations/RIF/simtabR1")

HumanPKmodel<-HumanPKmodel%>%
  filter(ID<=5)%>%
  filter(DOSE == 569) %>% 
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIMEH)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="human")

MousePKmodel<-read_nm_table("../data/PK_simulations/RIF/nan23")

MousePKmodel<-MousePKmodel%>%
  filter(DOSE == 569) %>%
  filter(ID<=5)%>%
  filter(!(EVID==0&TIME==0))%>%
  group_by(DOSE,TIME)%>%
  summarise(Q1=quantile(C2,prob=0.025,na.rm=T),
            Q2=quantile(C2,prob=0.5,na.rm=T),
            Q3=quantile(C2,prob=0.975,na.rm=T))%>%
  mutate(model="mice", TIMEH=TIME)

rif_scaled_data <- bind_rows(HumanPKmodel, MousePKmodel)

rif_scaled_pk <- ggplot(data = rif_scaled_data, aes(x=TIMEH, y = Q2, color=model,fill=model))+
  geom_ribbon(aes(ymin = Q1, ymax = Q3), alpha = 0.4, size = 0.01) +
  geom_line() +
  theme_bw()+
  facet_wrap(~DOSE, nrow=2)+
  scale_color_manual(values = scaled) +
  scale_fill_manual(values = scaled) +
  ggtitle("RIF")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none") 
  
rif_scaled_pk
```

###RPT

```{r}
setwd("../data/PK_simulations/RPT/")
simPKPD2<- read_nm_table("sdtabPPKPD06")
names(simPKPD2)
unique(simPKPD2$DOSE)
simPKPD2 <- simPKPD2 %>%
 filter(MDV==0) %>%
 mutate(IPRED = log10(exp(IPRED)),
        PRED  = log10(exp(IPRED))) %>%
 mutate(Dose   = factor(case_when(DOSE == 300 ~ "300 mg",
                                  DOSE == 600 ~ "600 mg",
                                  DOSE == 900 ~ "900 mg",
                                  DOSE == 1200 ~ "1200 mg"),
                        levels=c("300 mg","600 mg","900 mg","1200 mg"))) %>%
 group_by(ID)
simPKPD3<- read_nm_table("sdtabPPKPD02b")
names(simPKPD3)
unique(simPKPD3$DOSE)
simPKPD3 <- simPKPD3 %>%
 filter(MDV==0) %>%
 mutate(IPRED = log10(exp(IPRED)),
        PRED  = log10(exp(IPRED))) %>%
 mutate(Dose   = factor(case_when(DOSE == 300 ~ "300 mg",
                                  DOSE == 600 ~ "600 mg",
                                  DOSE == 900 ~ "900 mg",
                                  DOSE == 1200 ~ "1200 mg"),
                        levels=c("300 mg","600 mg","900 mg","1200 mg"))) %>%
 group_by(ID)
simPKPD2$model <-"RPT scaled"
simPKPD3$model <-"RPT human"
SIM4 <- rbind(simPKPD2, simPKPD3)


rpt_scaled_PK <- ggplot(data = subset(SIM4, DOSE==900), aes(x=TIME, y = CP, color=as.factor(model),fill=as.factor(model)))+
 stat_summary(geom="ribbon",fun.ymin = function(x) quantile(x, 0.025), fun.ymax = function(x) quantile(x, 0.975), alpha=0.5, lwd = 0.0001) +
  facet_wrap(~DOSE)+
 stat_summary(geom="line", fun.y=median)+
 scale_color_manual(values = scaled) +
  scale_fill_manual(values = scaled) +
  ggtitle("RPT")+
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48), limits = c(0,48))+
  theme_bw()+
  theme(strip.background = element_rect(fill = NA, color = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none") 

rpt_scaled_PK 
```
##combined
```{r fig.height=8, fig.width=8}
humanS_PK <- grid.arrange(
  bdq_scaled_pk,
  dlm_scaled_pk,
  inh_scaled_pk,
  lzd_scaled_pk,
  mfx_scaled_pk,
  pa824_scaled_pk,
  pza_scaled_pk,
  rif_scaled_pk,
  rpt_scaled_PK,
  nrow = 3,
  left="Concentration (mg/L)",
  bottom="Time (hrs)"
)

humanS_PK

ggsave(plot = humanS_PK, "../Manuscript/eba_figures/figure4.pdf", width = 12, height = 12)
```

#Figure 8 Drugs ranked

```{r fig.height=6, fig.width=10}

#EBA_sum <- filter()

EBA_sum <- read.csv("../data/eba_simulations/EBA_all/Composite_Data_change_CFU_summarize.csv")
#EBA_all <- na.omit(EBA_all)


EBA_ns_plot_ranking_mouse <- ggplot(subset(EBA_sum), aes(x = reorder(paste(drug, dose_mg, "mg"), -change_cfu_sim), y = change_cfu_sim))+
  #geom_errorbar(aes(y = 0-EBAsim, ymin=0-EBAsim95LB, ymax=0-EBAsim95UB), color = "#42B1AF", width=0.001, size = 5, alpha = 0.3)+
  geom_boxplot(aes(middle = change_cfu_sim, upper =change_cfu_upper_sim, lower = change_cfu_lower_sim, ymin=change_cfu_lower_sim, ymax=change_cfu_upper_sim), fill = "#c0e5e4", color = "NA", stat = "identity", position = position_dodge2(preserve = "single", width = 0.2), width = 0.5)+
  geom_point(aes(y = change_cfu_sim),  size = 2, shape = 21, stroke = 1, fill = "white", color = "#42b1af")+
  geom_hline(yintercept = 0, linetype = 2)+
  ggtitle("Simulated data ranked")+
  #geom_point()+
  labs(y = "", x = "")+
  #geom_errorbar(aes(y = 0-EBAlit, ymin=0-EBAlit95LB, ymax=0-EBAlit95UB), width=.0000000001)+
  scale_y_reverse(limits = c(0.1, NA))+
  coord_flip()+
  theme_bw()+
  theme(strip.background = element_rect(fill = 'white', colour = 'black'))

EBA_ns_plot_ranking_human <- ggplot(subset(EBA_sum), aes(x = reorder(paste(drug, dose_mg, "mg"), -change_cfu_lit), y = change_cfu_lit))+
  #geom_errorbar(aes(y = 0-EBAsim, ymin=0-EBAsim95LB, ymax=0-EBAsim95UB), color = "#42B1AF", width=0.001, size = 5, alpha = 0.3)+
  #geom_boxplot(aes(middle = 0-maxSimChange, upper =0-EBAsim95UB, lower = 0-EBAsim95LB, ymin=0-EBAsim95LB, ymax=0-EBAsim95UB), fill = "#c0e5e4", color = "NA", stat = "identity", position = position_dodge2(preserve = "single", width = 0.8))+
  #geom_point(aes(y = 0-maxSimChange),  size = 2, shape = 21, stroke = 1, fill = "white", color = "#42b1af")+
  geom_point()+
  ggtitle("Clinical data ranked")+
  labs(y = "", x = "")+
  #geom_linerange(aes(ymin=EBAlit95LB, ymax=EBAlit95UB))+
  geom_hline(yintercept = 0, linetype = 2)+
  coord_flip()+
  scale_y_reverse(limits = c(0.1, NA))+
  theme_bw()+
  theme(strip.background = element_rect(fill = 'white', colour = 'black'))

ranked_fig <- grid.arrange(
EBA_ns_plot_ranking_mouse,
EBA_ns_plot_ranking_human, nrow = 1,
bottom = "Change in CFU from baseline"
)

ranked_fig

ggsave(plot = ranked_fig, "../Manuscript/eba_figures/figure6.pdf", width = 10, height = 6)
```

#Figure S3 comparison of different infection models
####PA824
```{r fig.height=3, fig.width=24}
setwd("../data/eba_simulations/PA824/")
simpkpd6 <- read_nm_tables("sdtabPAPKPD9a1")
simpkpd6 <- simpkpd6[simpkpd6$MDV==0,]

simpkpd6$IDd[simpkpd6$ID== 1] <- "200 mg-1"
simpkpd6$IDd[simpkpd6$ID== 5] <- "200 mg-2"
simpkpd6$IDd[simpkpd6$DOSE == 600] <- "600 mg"
simpkpd6$IDd[simpkpd6$DOSE == 1000] <- "1000 mg"
simpkpd6$IDd[simpkpd6$DOSE == 1200] <- "1200 mg"
simpkpd6$IDd[simpkpd6$DOSE==150] <- "150 mg"
simpkpd6$IDd[simpkpd6$DOSE == 100] <- "100 mg"
simpkpd6$IDd[simpkpd6$DOSE == 50] <- "50 mg"

simpkpd6$IPRED <- log10(exp(simpkpd6$IPRED))
simpkpd6$PRED <- log10(exp(simpkpd6$PRED))
simpkpd6$KILL<- (simpkpd6$PRED-simpkpd6$STARTCFULOG)
simpkpd6$iKILL<- -(simpkpd6$IPRED-simpkpd6$STARTCFULOG)
simpa1<-simpkpd6
simpa1$model <- "acute"



DiaconPA <- read.csv("PA-Diacon2.csv", skip = 2, header = T)
names(DiaconPA) <- c("ID","TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(DiaconPA)[9:22])

DiaconPA$DOSE <- as.numeric(DiaconPA$DOSE)

DiaconPA <- DiaconPA %>% arrange(DOSE)

DiaconPA$IDd[DiaconPA$ID== 1] <- "200 mg-1"
DiaconPA$IDd[DiaconPA$ID== 8] <- "200 mg-2"
DiaconPA$IDd[DiaconPA$DOSE == 600] <- "600 mg"
DiaconPA$IDd[DiaconPA$DOSE == 1000] <- "1000 mg"
DiaconPA$IDd[DiaconPA$DOSE == 1200] <- "1200 mg"
DiaconPA$IDd[DiaconPA$DOSE==150] <- "150 mg"
DiaconPA$IDd[DiaconPA$DOSE == 100] <- "100 mg"
DiaconPA$IDd[DiaconPA$DOSE == 50] <- "50 mg"
DiaconPA$model<-"reference"

simpkpd6 <- read_nm_tables("sdtabPAPKPD10d1")
simpkpd6 <- simpkpd6[simpkpd6$MDV==0,]

simpkpd6$IDd[simpkpd6$ID== 1] <- "200 mg-1"
simpkpd6$IDd[simpkpd6$ID== 5] <- "200 mg-2"
simpkpd6$IDd[simpkpd6$DOSE == 600] <- "600 mg"
simpkpd6$IDd[simpkpd6$DOSE == 1000] <- "1000 mg"
simpkpd6$IDd[simpkpd6$DOSE == 1200] <- "1200 mg"
simpkpd6$IDd[simpkpd6$DOSE==150] <- "150 mg"
simpkpd6$IDd[simpkpd6$DOSE == 100] <- "100 mg"
simpkpd6$IDd[simpkpd6$DOSE == 50] <- "50 mg"

simpkpd6$IPRED <- log10(exp(simpkpd6$IPRED))
simpkpd6$PRED <- log10(exp(simpkpd6$PRED))
simpkpd6$KILL<- (simpkpd6$PRED-simpkpd6$STARTCFULOG)
simpkpd6$iKILL<- -(simpkpd6$IPRED-simpkpd6$STARTCFULOG)
simpa2 <- simpkpd6
simpa2$model <- "subacute"

simpkpd6 <- read_nm_tables("sdtabPAPKPD11d1")
simpkpd6 <- simpkpd6[simpkpd6$MDV==0,]

simpkpd6$IDd[simpkpd6$ID== 1] <- "200 mg-1"
simpkpd6$IDd[simpkpd6$ID== 5] <- "200 mg-2"
simpkpd6$IDd[simpkpd6$DOSE == 600] <- "600 mg"
simpkpd6$IDd[simpkpd6$DOSE == 1000] <- "1000 mg"
simpkpd6$IDd[simpkpd6$DOSE == 1200] <- "1200 mg"
simpkpd6$IDd[simpkpd6$DOSE==150] <- "150 mg"
simpkpd6$IDd[simpkpd6$DOSE == 100] <- "100 mg"
simpkpd6$IDd[simpkpd6$DOSE == 50] <- "50 mg"

simpkpd6$IPRED <- log10(exp(simpkpd6$IPRED))
simpkpd6$PRED <- log10(exp(simpkpd6$PRED))
simpkpd6$KILL<- (simpkpd6$PRED-simpkpd6$STARTCFULOG)
simpkpd6$iKILL<- -(simpkpd6$IPRED-simpkpd6$STARTCFULOG)
simpa3 <- simpkpd6
simpa3$model <- "chronic"

SIM <- rbind(simpa1, simpa2, simpa3)
SIM <- filter(SIM, TIME<=2)

ggplot(data = subset(SIM, TIME<=2), aes(x = TIME, y = IPRED, color=as.factor(model), fill=as.factor(model) ))+
  theme_bw() +
  facet_wrap(~IDd, nrow=1, scales = "free")+
  scale_color_manual(values = EBA_team)+
  scale_fill_manual(values = EBA_team)+
  stat_summary(geom="ribbon",fun.ymin = function(x) quantile(x, 0.341), fun.ymax = function(x) quantile(x, 0.682), alpha = 0.4, color=NA) + 
  stat_summary(geom="line", fun.y=mean)+
  geom_point(data = subset(DiaconPA, TIME<=2), aes(x = TIME,y = log.CFU), color="black")+
  #geom_errorbar(data=DiaconPA, aes(x=TIME, y=log.CFU,ymin=log.CFU-SD, ymax=log.CFU+SD), color="black", width=.01)+
  #stat_summary(geom="line", data = litdata, fun.y = mean, aes(x = TIME,y = KILL))+
  labs(x = "Time (Days)", y = expression(paste("Change in log"["10"],"CFU/mL from Baseline"))) +
  ggtitle("PA824")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )

```


####MFX
```{r fig.height=3, fig.width=9}
setwd("../data/eba_simulations/MFX/")
simm3 <- read_nm_tables("sdtabMpkpd5e2")
#simm3 <- simm3[simm3$MDV==0,]
simm3$IPRED <- log10(exp(simm3$IPRED))
simm3$PRED <- log10(exp(simm3$PRED))
simm3$KILL<- (simm3$PRED-simm3$STARTCFULOG)
simm3$iKILL<- -(simm3$IPRED-simm3$STARTCFULOG)

mxf <- read.csv("MXF-2.csv",header=TRUE, skip=2)
names(mxf) <- c("TIME","KILL","BASELINE","log.CFU","SD","Study","DOSE",names(mxf)[8:13])
mxf$IDd[mxf$Study=="Johnson"] <-  "Johnson 400 mg" 
mxf$IDd[mxf$Study=="Pletz"] <-  "Pletz 400 mg" 
mxf$IDd[mxf$Study=="Gosling"] <-  "Goslins 400 mg" 

simm3$IDd[simm3$ID==1]<- "Johnson 400 mg"
simm3$IDd[simm3$ID==2]<- "Pletz 400 mg"
simm3$IDd[simm3$ID==3]<- "Goslins 400 mg"
#simm3$IDd[simm3$ID==4]<- "Johnson 400 mg"
#simm3$IDd[simm3$ID==5]<- "Pletz 400 mg"
#simm3$IDd[simm3$ID==6]<- "Goslins 400 mg"
#simm3$IDd[simm3$ID==7]<- "Johnson 400 mg"
#simm3$IDd[simm3$ID==8]<- "Pletz 400 mg"
#simm3$IDd[simm3$ID==9]<- "Goslins 400 mg"
simm3$model <-"acute"

simm4 <- read_nm_tables("sdtabMpkpd6b1")
#simm4 <- simm4[simm4$MDV==0,]
simm4$IPRED <- log10(exp(simm4$IPRED))
simm4$PRED <- log10(exp(simm4$PRED))
simm4$KILL<- (simm4$PRED-simm4$STARTCFULOG)
simm4$iKILL<- -(simm4$IPRED-simm4$STARTCFULOG)
simm4$IDd[simm4$ID==1]<- "Johnson 400 mg"
simm4$IDd[simm4$ID==2]<- "Pletz 400 mg"
simm4$IDd[simm4$ID==3]<- "Goslins 400 mg"
#simm4$IDd[simm4$ID==4]<- "Johnson 400 mg"
#simm4$IDd[simm4$ID==5]<- "Pletz 400 mg"
#simm4$IDd[simm4$ID==6]<- "Goslins 400 mg"
#simm4$IDd[simm4$ID==7]<- "Johnson 400 mg"
#simm4$IDd[simm4$ID==8]<- "Pletz 400 mg"
#simm4$IDd[simm4$ID==9]<- "Goslins 400 mg"
simm4$model <-"chronic"

simm5 <- read_nm_tables("sdtabMpkpd7b1")
simm5 <- simm5[simm5$MDV==0,]
simm5$IPRED <- log10(exp(simm5$IPRED))
simm5$PRED <- log10(exp(simm5$PRED))
simm5$KILL<- (simm5$PRED-simm5$STARTCFULOG)
simm5$iKILL<- -(simm5$IPRED-simm5$STARTCFULOG)
simm5$IDd[simm5$ID==1]<- "Johnson 400 mg"
simm5$IDd[simm5$ID==2]<- "Pletz 400 mg"
simm5$IDd[simm5$ID==3]<- "Goslins 400 mg"
#simm5$IDd[simm5$ID==4]<- "Johnson 400 mg"
#simm5$IDd[simm5$ID==5]<- "Pletz 400 mg"
#simm5$IDd[simm5$ID==6]<- "Goslins 400 mg"
#simm5$IDd[simm5$ID==7]<- "Johnson 400 mg"
#simm5$IDd[simm5$ID==8]<- "Pletz 400 mg"
#simm5$IDd[simm5$ID==9]<- "Goslins 400 mg"
simm5$model <-"subacute"

mxf$model<- "reference"
MOX <- rbind(simm3, simm4, simm5)
MOX$model <- as.factor(MOX$model)
#simm3.1 <- filter(simm3,IDd=="Johnson 400 mg")
#mxf1 <- mxf[c(1:8),]
#MOX<- filter(MOX, TIME<=2), 

ggplot(subset(MOX, TIME <= 2), aes(x=TIME, y=IPRED,color=model,fill = model ))+
  #geom_point()+
  theme_bw()+
  stat_summary(geom="ribbon", fun.ymin = function(x) quantile(x, 0.341), fun.ymax = function(x) quantile(x, 0.682), alpha = 0.3, color=NA) + 
  stat_summary(geom = "line",fun.y = mean, size=0.8, lwd=0.8)+
  geom_point(data = subset(mxf, TIME <=2), aes(x = TIME,y = log.CFU), color="black")+
  scale_color_manual(values = EBA_team)+
  scale_fill_manual(values = EBA_team)+
  labs(x = "Time (Days)", y = expression(paste("log"["10"],"CFU/mL from Baseline")))+
  guides(colour = guide_legend(title = "infection model"))+
 # geom_errorbar(data=mxf, aes(x=TIME, y=log.CFU,ymin=log.CFU-SD, ymax=log.CFU+SD), color="black",width=.01)+
  ggtitle("MFX")+
  scale_x_continuous(
                     breaks = c(seq(0,8,2)),
                     minor_breaks = c(seq(0,8,2)),
                     labels = c("0","2","4","6","8"))+
  facet_wrap(~IDd, scales = "free_y")+
  theme(
    strip.background = element_rect(fill = NA, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )
```

###RIF Knet
```{r fig.height=3.5, fig.width=15}
#setwd("../data/eba_simulations/r/")
simpkpd1 <- read_nm_table("../data/eba_simulations/RIF/simtabR11")%>%
   filter(ID<=5)%>%
  filter(MDV==0)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)
#  mutate(WTBSD=paste(as.character(WTBSD),"mg/kg"))

simpkpd_summary1<-simpkpd1%>%
  group_by(TIME,WTBSD)%>%
  summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
            Q2=quantile(DV,prob=0.5,na.rm=T),
            Q3=quantile(DV,prob=0.975,na.rm=T))%>%
  mutate(model=" acute")

simEBA1<-simpkpd1%>%
  filter(TIME==7)%>%
  group_by(WTBSD)%>%
  mutate(EBA=(0-iKILL)/7)%>%
  select(WTBSD,EBA)%>%
  distinct(WTBSD,.keep_all=TRUE)

simEBA1<-simpkpd1%>%
  filter(TIME==2)%>%
  group_by(WTBSD)%>%
  mutate(EBA=(0-iKILL)/2)%>%
  select(WTBSD,EBA)%>%
  distinct(WTBSD,.keep_all=TRUE)

#simpkpd2 <- read_nm_table("simtabR3") #final sub-acute 103d

simpkpd2 <- read_nm_table("../data/eba_simulations/RIF/simtabR12")%>%
   filter(ID<=5)%>%
 # filter(REP<=2)%>%
  filter(MDV==0)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)
#  mutate(WTBSD=paste(as.character(WTBSD),"mg/kg"))

simpkpd_summary2<-simpkpd2%>%
  group_by(TIME,WTBSD)%>%
  summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
            Q2=quantile(DV,prob=0.5,na.rm=T),
            Q3=quantile(DV,prob=0.975,na.rm=T))%>%
  mutate(model=" sub-acute")

simEBA2<-simpkpd2%>%
  filter(TIME==7)%>%
  group_by(WTBSD)%>%
  mutate(EBA=(0-iKILL)/7)%>%
  select(WTBSD,EBA)%>%
  distinct(WTBSD,.keep_all=TRUE)

simEBA2<-simpkpd2%>%
  filter(TIME==2)%>%
  group_by(WTBSD)%>%
  mutate(EBA=(0-iKILL)/2)%>%
  select(WTBSD,EBA)%>%
  distinct(WTBSD,.keep_all=TRUE)



simpkpd3 <- read_nm_table("../data/eba_simulations/RIF/simtabR13")%>%
  filter(ID<=5)%>%
  filter(MDV==0)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)
#  mutate(WTBSD=paste(as.character(WTBSD),"mg/kg"))

simpkpd_summary3<-simpkpd3%>%
  group_by(TIME,WTBSD)%>%
  summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
            Q2=quantile(DV,prob=0.5,na.rm=T),
            Q3=quantile(DV,prob=0.975,na.rm=T))%>%
  mutate(model="chronic")

simEBA3<-simpkpd3%>%
  filter(TIME==7)%>%
  group_by(WTBSD)%>%
  mutate(EBA=(0-iKILL)/7)%>%
  select(WTBSD,EBA)%>%
  distinct(WTBSD,.keep_all=TRUE)

simEBA3<-simpkpd3%>%
  filter(TIME==2)%>%
  group_by(WTBSD)%>%
  mutate(EBA=(0-iKILL)/2)%>%
  select(WTBSD,EBA)%>%
  distinct(WTBSD,.keep_all=TRUE)

simpkpd_summary<-rbind(simpkpd_summary1,simpkpd_summary2,simpkpd_summary3)

boeree_all <- read.csv("../data/eba_simulations/RIF/Boeree for R_alldose.csv", header=TRUE, skip =2)
names(boeree_all) <- c("TIME","KILL","BASELINE","log.CFU","WTBSD","Study","KillLB","KillUB","DOSE")

#boeree_all <- boeree_all%>%
#  mutate(DOSE=paste(as.character(DOSE),"mg"))

dose.labs <- c("600 mg", "1050 mg", "1350 mg", "1650 mg", "1950 mg")
names(dose.labs) <- c("10", "20", "25", "30", "35")


#time vs effect in human
ggplot()+
  xlab("Time (Days)") +
  ylab(expression(paste("Log" ["10"]," CFU/mL"))) +
    geom_line(data=simpkpd_summary,aes(x=TIME,y=Q2,group=model,color=factor(model)),linetype=1,size=1) +
  geom_ribbon(data=simpkpd_summary,aes(x=TIME,ymin=Q1,ymax=Q3,fill=factor(model)),alpha=0.4,lwd=0.8) +  
  geom_point(data=boeree_all, aes(x=TIME,y=log.CFU),color="black",size=2) +
  
  #geom_point(data=donaldinh,aes(x=TIME,y=log10cfu), color="black",size=2) +
  guides(colour = guide_legend(title = "Infection Model"),fill = FALSE)  +
  scale_color_manual(values=EBA_team)  +
  #ggtitle("Sub-acute Infection Model-based EBA Prediction")  + 
  scale_fill_manual(values=EBA_team)  +
  ylim(c(1,6))+
  ggtitle("RIF")+
  scale_x_continuous(limits=c(0, 7), breaks=seq(0,14,2)) +
  #geom_hline(yintercept=(10), linetype=2, color="red", size=1)+
  theme_bw(base_size=10) +
  facet_wrap(~WTBSD,   labeller = labeller(WTBSD = dose.labs), nrow = 1) +
  theme(    strip.background = element_rect(fill = NA, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position="bottom")

```

###PZA Knet
```{r fig.height=3, fig.width=3}
#setwd("~/Dropbox (Savic_Lab)/Nan/EBA Export Mar 2019/final sims/Pyrazinamide_Nan")
#simpkpd1 <- read_nm_table("simtabZ10") # final acute model 205a

#simpkpd1 <- read_nm_table("simtabZ11") # final sub-acute model 234a

#simpkpd1 <- read_nm_table("simtabZ12") # final chronic model 234a


simpkpd1 <- read_nm_table("../data/eba_simulations/PZA/simtabZ10a")%>% # final acute model 205a
  filter(ID>4)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)%>%
  mutate(DOSE1=paste(as.character(DOSE),"mg"))

simpkpd_summary1<-simpkpd1%>%
 # mutate(NID=ifelse(ID==1|ID==2,"Botha","Jindani"))%>%
  filter(MDV==0)%>%
  group_by(TIME)%>%
  summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
            Q2=quantile(DV,prob=0.5,na.rm=T),
            Q3=quantile(DV,prob=0.975,na.rm=T))%>%
  #filter(NID=="Botha")%>%
  mutate(model=" acute")

simEBA11<-simpkpd1%>%
  filter(TIME==2)%>%
  group_by(DOSE)%>%
  mutate(EBA=(0-iKILL)/2)%>%
  select(DOSE,EBA)%>%
  distinct(DOSE,.keep_all=TRUE)

simEBA1<-simpkpd1%>%
  filter(TIME==14)%>%
  group_by(DOSE)%>%
  mutate(EBA=(0-iKILL)/14)%>%
  select(DOSE,EBA)%>%
  distinct(DOSE,.keep_all=TRUE)


simpkpd2 <- read_nm_table("../data/eba_simulations/PZA/simtabZ11a")%>% # final acute model 234a
  filter(ID>4)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)%>%
  mutate(DOSE1=paste(as.character(DOSE),"mg"))

simpkpd_summary2<-simpkpd2%>%
  #mutate(NID=ifelse(ID==1|ID==2,"Botha","Jindani"))%>%
  filter(MDV==0)%>%
  group_by(TIME)%>%
  summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
            Q2=quantile(DV,prob=0.5,na.rm=T),
            Q3=quantile(DV,prob=0.975,na.rm=T))%>%
  #filter(NID=="Botha")%>%
  mutate(model=" sub-acute")

simEBA12<-simpkpd2%>%
  filter(TIME==2)%>%
  group_by(DOSE)%>%
  mutate(EBA=(0-iKILL)/2)%>%
  select(DOSE,EBA)%>%
  distinct(DOSE,.keep_all=TRUE)

simEBA2<-simpkpd2%>%
  filter(TIME==14)%>%
  group_by(DOSE)%>%
  mutate(EBA=(0-iKILL)/14)%>%
  select(DOSE,EBA)%>%
  distinct(DOSE,.keep_all=TRUE)

simpkpd3 <- read_nm_table("../data/eba_simulations/PZA/simtabZ12a")%>% # final acute model 255c
  filter(ID>4)%>%
  mutate(IPRED=log10(exp(IPRED)),
         PRED=log10(exp(PRED)),
         DV=log10(exp(DV)),
         KILL=PRED-STARTCFULOG,
         iKILL=IPRED-STARTCFULOG)%>%
  mutate(DOSE1=paste(as.character(DOSE),"mg"))

simpkpd_summary3<-simpkpd3%>%
  #mutate(NID=ifelse(ID==1|ID==2,"Botha","Jindani"))%>%
  filter(MDV==0)%>%
  group_by(TIME)%>%
  summarise(Q1=quantile(DV,prob=0.025,na.rm=T),
            Q2=quantile(DV,prob=0.5,na.rm=T),
            Q3=quantile(DV,prob=0.975,na.rm=T))%>%
  #filter(NID=="Botha")%>%
  mutate(model="chronic")

simEBA3<-simpkpd3%>%
  filter(TIME==14)%>%
  group_by(DOSE)%>%
  mutate(EBA=(0-iKILL)/14)%>%
  select(DOSE,EBA)%>%
  distinct(DOSE,.keep_all=TRUE)

simEBA13<-simpkpd3%>%
  filter(TIME==2)%>%
  group_by(DOSE)%>%
  mutate(EBA=(0-iKILL)/2)%>%
  select(DOSE,EBA)%>%
  distinct(DOSE,.keep_all=TRUE)

simpkpd_summary<-rbind(simpkpd_summary1,simpkpd_summary2,simpkpd_summary3)


#time vs effect in human
 
 litdata <- read.csv("../data/eba_simulations/PZA/PZAData.csv", header=TRUE, skip =2)
 names(litdata) <- c("TIME","KILL","BASELINE","log.CFU","Study","Dose","EBA02", "EBA214","ID")
 
 litdata<-litdata%>%
   filter((ID>0&Study=="Jindani"))%>%
   rename(STARTCFULOG=BASELINE)%>%
   group_by(TIME)%>%
   mutate(CFU=mean(log.CFU))
   

 ggplot()+
   xlab("Time (Days)") +
   ylab(expression(paste("Log" ["10"]," CFU/mL"))) +
   geom_ribbon(data=simpkpd_summary,aes(x=TIME,ymin=Q1,ymax=Q3, fill=factor(model)),alpha=0.4) +  
   geom_line(data=simpkpd_summary,aes(x=TIME,y=Q2,color=factor(model))) +
   geom_point(data=litdata,aes(x=TIME,y=CFU),shape=1, color="black") +
   #ggtitle("Sub-acute Infection Model-based EBA Prediction")  + 
   guides(colour = guide_legend(title = "Infection Model"),fill = guide_legend(title = "Infection Model"))  +
   ylim(c(2,8)) +
   scale_color_manual(values=EBA_team)  +
  ggtitle("PZA")  + 
  scale_fill_manual(values=EBA_team)  +
   scale_x_continuous(limits=c(0, 14), breaks=seq(0,14,2)) +
   theme_bw() +
   theme(    strip.background = element_rect(fill = NA, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position="none")
 
 

```
